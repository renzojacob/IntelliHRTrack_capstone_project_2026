{% extends 'employee/base_employee.html' %}

{% block title %}Leave | IntelliHRTrack{% endblock %}

{% block content %}

<!-- Header -->
<header class="relative overflow-hidden rounded-3xl glass p-6 md:p-8 shadow-lg reveal">
  <div class="absolute inset-0 opacity-40 animate-shine"></div>
  <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="relative">
        <img class="w-16 h-16 md:w-20 md:h-20 rounded-full object-cover border-4 border-white/50 shadow-lg"
             src="https://randomuser.me/api/portraits/men/32.jpg" alt="Employee">
        <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 rounded-full border-2 border-white"></div>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Leave & Requests</h1>
        <p class="text-sm md:text-base text-gray-600 dark:text-gray-300 mt-1">Manage your time off, track balances, and submit requests</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="mobileMenu" class="lg:hidden p-2 rounded-xl glass" aria-label="Open Menu">
        <iconify-icon icon="ph:list-duotone"></iconify-icon>
      </button>
      <div class="hidden md:flex items-center gap-2 px-3 py-1 rounded-xl glass text-xs">
        <span id="netDot" class="inline-block w-2.5 h-2.5 rounded-full bg-green-500" title="Online"></span>
        <span id="headerClock">--:--:--</span>
      </div>
      <button id="themeToggleHeader" class="p-2 rounded-xl glass hover:shadow-glow transition">
        <iconify-icon icon="ph:sun-dim-duotone" class="hidden dark:inline text-accent"></iconify-icon>
        <iconify-icon icon="ph:moon-stars-duotone" class="dark:hidden text-accent"></iconify-icon>
      </button>
    </div>
  </div>
</header>

<!-- âœ… Leave Summary -->
<div class="grid grid-cols-1 sm:grid-cols-5 gap-4 mt-6">
  <!-- Total Leave This Year -->
  <div class="glass rounded-3xl p-5 shadow-md reveal">
    <p class="text-sm text-gray-500 dark:text-gray-400">Total Leave This Year</p>
    <h3 class="text-3xl font-extrabold mt-1 text-blue-600">
      {{ total_leave_used|default:0 }}
    </h3>
    <p class="text-xs text-gray-400 mt-1">Out of 5 days allowed</p>
  </div>

  <!-- Pending Requests -->
  <div class="glass rounded-3xl p-5 shadow-md reveal">
    <p class="text-sm text-gray-500 dark:text-gray-400">Pending Requests</p>
    <h3 class="text-3xl font-extrabold mt-1 text-amber-500">
      {{ pending_leave_count|default:0 }}
    </h3>
    <p class="text-xs text-gray-400 mt-1">Awaiting approval</p>
  </div>

  <!-- Remaining Leave -->
  <div class="glass rounded-3xl p-5 shadow-md reveal">
    <p class="text-sm text-gray-500 dark:text-gray-400">Remaining Leave</p>
    <h3 class="text-3xl font-extrabold mt-1 text-emerald-500">
      {{ remaining_leave|default:5 }}
    </h3>
    <p class="text-xs text-gray-400 mt-1">Days left this year</p>
  </div>

  <!-- Approved Requests -->
  <div class="glass rounded-3xl p-5 shadow-md reveal">
    <p class="text-sm text-gray-500 dark:text-gray-400">Approved</p>
    <h3 class="text-3xl font-extrabold mt-1 text-green-600">{{ approved_count|default:0 }}</h3>
    <p class="text-xs text-gray-400 mt-1">Approved requests</p>
  </div>

  <!-- Rejected Requests -->
  <div class="glass rounded-3xl p-5 shadow-md reveal">
    <p class="text-sm text-gray-500 dark:text-gray-400">Rejected</p>
    <h3 class="text-3xl font-extrabold mt-1 text-red-600">{{ rejected_count|default:0 }}</h3>
    <p class="text-xs text-gray-400 mt-1">Rejected requests</p>
  </div>
</div>

<!-- âœ… Django messages (success/error) -->
{% if messages %}
  <div class="mt-4 space-y-2">
    {% for message in messages %}
      <div class="glass rounded-2xl p-4 border border-white/40 dark:border-white/10
                  {% if message.tags == 'success' %} bg-emerald-50/60 dark:bg-emerald-900/20 {% endif %}
                  {% if message.tags == 'error' %} bg-rose-50/60 dark:bg-rose-900/20 {% endif %}
                  {% if message.tags == 'warning' %} bg-amber-50/60 dark:bg-amber-900/20 {% endif %}">
        <div class="text-sm font-medium">
          {{ message }}
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Layout -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mt-6">

  <!-- LEFT -->
  <div class="space-y-6">

    <!-- âœ… Apply for Leave (WORKING FORM) -->
    <div class="glass rounded-3xl p-6 shadow-lg reveal">
      <h2 class="text-xl font-bold mb-4">Apply for Leave</h2>

      <form
        method="POST"
        action="{% url 'employee_leave' %}"
        enctype="multipart/form-data"
        class="space-y-4"
        id="leaveForm"
      >
        {% csrf_token %}

        <!-- Leave Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Leave Type</label>
          <select
            name="leave_type"
            required
            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 glass py-3 px-4"
          >
            <option value="">Select leave type...</option>
            <option value="VACATION">Vacation Leave</option>
            <option value="SICK">Sick Leave</option>
            <option value="EMERGENCY">Emergency Leave</option>
            <option value="OFFICIAL">Official Business</option>
            <option value="MATERNITY">Maternity Leave</option>
            <option value="PATERNITY">Paternity Leave</option>
          </select>
        </div>

        <!-- Dates -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
            <input
              name="start_date"
              type="date"
              required
              class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 glass py-3 px-4"
              id="startDate"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date</label>
            <input
              name="end_date"
              type="date"
              required
              class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 glass py-3 px-4"
              id="endDate"
            >
          </div>
        </div>

        <!-- Duration -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Duration</label>
          <div class="flex gap-4 flex-wrap">
            <label class="flex items-center">
              <input type="radio" name="duration" value="FULL" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2" checked>
              <span class="text-sm text-gray-700 dark:text-gray-300">Full Day</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="duration" value="HALF_AM" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
              <span class="text-sm text-gray-700 dark:text-gray-300">Half Day (AM)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="duration" value="HALF_PM" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
              <span class="text-sm text-gray-700 dark:text-gray-300">Half Day (PM)</span>
            </label>
          </div>
        </div>

        <!-- Reason -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reason</label>
          <textarea
            name="reason"
            required
            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 glass py-3 px-4"
            rows="3"
            placeholder="Please provide details for your leave request..."
          ></textarea>
        </div>

        <!-- Supporting Docs -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Supporting Documents</label>
          <div class="flex items-center justify-center w-full">
            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer glass hover:border-accent transition-colors">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <iconify-icon icon="ph:cloud-arrow-up-duotone" class="text-gray-400 text-2xl mb-2"></iconify-icon>
                <p class="text-sm text-gray-500 dark:text-gray-400">Click to upload or drag and drop</p>
                <p class="text-xs text-gray-400 dark:text-gray-500">PDF, DOC, JPG up to 10MB</p>
              </div>
              <input name="attachments" type="file" class="hidden" multiple>
            </label>
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button type="submit" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-medium transition-all ripple" id="submitLeaveBtn">
            Submit Leave Request
          </button>

          <button type="submit" name="save_draft" value="1" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-medium transition-all ripple">
            Save as Draft
          </button>
        </div>
      </form>
    </div>

    <!-- âœ… Leave Request History (DYNAMIC FROM DB) -->
    <div class="glass rounded-3xl p-6 shadow-lg reveal">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <h2 class="text-xl font-bold">Leave Request History</h2>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700">
              <th class="text-left p-3">Leave Type</th>
              <th class="text-left p-3">Dates</th>
              <th class="text-left p-3">Duration</th>
              <th class="text-left p-3">Status</th>
              <th class="text-left p-3">Reviewed By</th>
              <th class="text-left p-3">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% if leave_requests %}
              {% for lr in leave_requests %}
                <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                  <td class="p-3 font-medium">{{ lr.leave_type }}</td>

                  <td class="p-3">
                    {{ lr.start_date }} â€” {{ lr.end_date }}
                  </td>

                  <td class="p-3">{{ lr.duration|default:"FULL" }}</td>

                  <td class="p-3">
                    {% if lr.status == "PENDING" %}
                      <span class="px-2 py-1 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs rounded-full">Pending</span>
                    {% elif lr.status == "APPROVED" %}
                      <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full">Approved</span>
                    {% elif lr.status == "REJECTED" %}
                      <span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs rounded-full">Rejected</span>
                    {% else %}
                      <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-full">{{ lr.status }}</span>
                    {% endif %}
                  </td>

                  <td class="p-3">
                    {% if lr.reviewed_by %}
                      {{ lr.reviewed_by.username }}
                    {% else %}
                      â€” 
                    {% endif %}
                  </td>

                  <td class="p-3">
                    {% if lr.status == "PENDING" %}
                      <form method="POST" action="{% url 'employee_leave_cancel' lr.id %}">
                        {% csrf_token %}
                        <button type="submit" class="text-red-500 hover:text-red-700 text-xs">Cancel</button>
                      </form>
                    {% else %}
                      <span class="text-xs text-gray-400">Locked</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td class="p-4 text-sm text-gray-500 dark:text-gray-400" colspan="6">
                  No leave requests yet.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="space-y-6">

    <!-- ðŸ”” Leave Notifications -->
    <div class="glass rounded-3xl p-6 shadow-lg reveal">
      <h2 class="text-xl font-bold mb-4">Leave Notifications</h2>

      {% if leave_notifications %}
        <ul class="space-y-3">
          {% for note in leave_notifications %}
            <li class="p-3 rounded-xl bg-white/50 dark:bg-gray-800 text-sm shadow">
              {{ note }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-gray-500 dark:text-gray-400">
          No new leave notifications.
        </p>
      {% endif %}
    </div>

    <!-- ðŸ“… Leave Calendar -->
    <div class="glass rounded-3xl p-6 shadow-lg reveal">
      <h2 class="text-xl font-bold mb-4">Leave Calendar</h2>

      <div class="grid grid-cols-7 gap-2 text-xs text-center">
        {% for event in calendar_events %}
          <div class="p-2 rounded-lg
            {% if event.status == 'APPROVED' %}
              bg-green-200 text-green-900
            {% elif event.status == 'PENDING' %}
              bg-amber-200 text-amber-900
            {% else %}
              bg-gray-200 text-gray-900
            {% endif %}
          ">
            <div class="font-semibold">{{ event.start }}</div>
            <div class="truncate">{{ event.title }}</div>
          </div>
        {% empty %}
          <p class="text-gray-500 col-span-7">
            No leave scheduled.
          </p>
        {% endfor %}
      </div>

      <p class="text-xs text-gray-400 mt-3">
        Calendar shows approved & pending leave dates.
      </p>
    </div>

  </div>

</div>

<footer class="pb-8 pt-6 text-xs text-gray-500 dark:text-gray-400 text-center">
  Â© IntelliHRTrack â€¢ Leave & Requests Portal
</footer>

{% endblock %}

{% block extra_js %}
<script>
  // Theme
  const themeToggleHeader = document.getElementById('themeToggleHeader');
  function toggleTheme(){
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('ih_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
  }
  themeToggleHeader?.addEventListener('click', toggleTheme);
  if (localStorage.getItem('ih_theme') === 'dark') document.documentElement.classList.add('dark');

  // Clock + net
  const headerClock = document.getElementById('headerClock');
  const netDot = document.getElementById('netDot');
  function updateClock(){ if(headerClock) headerClock.textContent = new Date().toLocaleTimeString(); }
  setInterval(updateClock, 1000); updateClock();
  function updateNet(){
    const on = navigator.onLine;
    if(netDot){
      netDot.classList.toggle('bg-green-500', on);
      netDot.classList.toggle('bg-rose-500', !on);
      netDot.title = on ? 'Online' : 'Offline';
    }
  }
  window.addEventListener('online', updateNet);
  window.addEventListener('offline', updateNet);
  updateNet();

  // âœ… Date validation (no alert spam, disable submit)
  const startDate = document.getElementById('startDate');
  const endDate = document.getElementById('endDate');
  const submitBtn = document.getElementById('submitLeaveBtn');

  function validateDates(){
    if(!startDate?.value || !endDate?.value) { submitBtn.disabled = false; return; }
    const s = new Date(startDate.value);
    const e = new Date(endDate.value);
    const bad = e < s;
    submitBtn.disabled = bad;
    if(bad){
      submitBtn.textContent = "Fix dates first";
    } else {
      submitBtn.textContent = "Submit Leave Request";
    }
  }
  startDate?.addEventListener('change', validateDates);
  endDate?.addEventListener('change', validateDates);
</script>
{% endblock %}
