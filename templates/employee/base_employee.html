{% load static %}
<!DOCTYPE html>
<html lang="en"
      class="h-full"
      data-accent="teal"
      data-bg="gradient"
      data-density="comfortable"
      data-font="base">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Employee | IntelliHRTrack{% endblock %}</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons (optional but nice) -->
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>

  <style>
    :root{
      --accent:#14b8a6; --accent-to:#0ea5a0;
      --card-bg:rgba(255,255,255,0.60); --card-border:rgba(255,255,255,0.35);
      --noise:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.035"/></svg>');
      --sidebar: 18rem;
    }

    html[data-accent="teal"]   { --accent:#14b8a6; --accent-to:#0ea5a0; }
    html[data-accent="purple"] { --accent:#8b5cf6; --accent-to:#7c3aed; }
    html[data-accent="rose"]   { --accent:#f43f5e; --accent-to:#e11d48; }
    html[data-accent="amber"]  { --accent:#f59e0b; --accent-to:#d97706; }
    html[data-bg="gradient"] body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(800px 400px at 10% -10%, rgba(59,130,246,0.15), transparent 60%),
        radial-gradient(600px 300px at 120% 0%, rgba(20,184,166,0.18), transparent 60%),
        linear-gradient(120deg, rgba(2,6,23,0.03), rgba(2,6,23,0.06));
    }
    html[data-bg="image"] body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('https://images.unsplash.com/photo-1531297484001-80022131f5a1?auto=format&fit=crop&w=2100&q=60') center/cover no-repeat fixed;
      filter:saturate(1.05) brightness(0.95);
    }
    body::after{ content:""; position:fixed; inset:0; pointer-events:none; z-index:-1; background-image:var(--noise); }

    .glass{ background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--card-border); }
    .dark .glass{ background: rgba(15,23,42,0.60); border-color: rgba(255,255,255,0.08); }
    .text-accent{ color: var(--accent); }
    .gradient-accent{ background-image: linear-gradient(135deg, var(--accent), var(--accent-to)); }
    .neon-divider{ height:1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity:.6; }

    .fancy-scroll::-webkit-scrollbar{ height:10px; width:10px; }
    .fancy-scroll::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, var(--accent), var(--accent-to)); border-radius:9999px; }
    .fancy-scroll::-webkit-scrollbar-track{ background: transparent; }

    .ripple{ position: relative; overflow: hidden; }
    .ripple::after{ content:''; position:absolute; inset:0; background: radial-gradient(circle, rgba(255,255,255,0.3) 1%, transparent 1%) center/15000%; opacity:0; transition: opacity .5s; }
    .ripple:active::after{ opacity:1; background-size:100%; transition:0s; }

    /* Sidebar resize */
    @media (min-width: 1024px){
      aside[data-resizable]{ width: var(--sidebar) !important; }
      main[data-shift]{ margin-left: var(--sidebar) !important; }
    }

    /* Top progress */
    #topProgress{ background-image: linear-gradient(90deg, var(--accent), var(--accent-to)); }

    /* Dark-mode form controls */
    select, input, textarea { color: #111827; }
    .dark select, .dark input, .dark textarea { background-color: rgba(255,255,255,0.08); color: #e5e7eb; border-color: rgba(255,255,255,0.15); }
    .dark select option { background-color: #0f172a; color: #e5e7eb; }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <!-- Top progress bar -->
  <div class="fixed top-0 left-0 right-0 h-1 z-[90]">
    <div id="topProgress" class="h-1 w-0 opacity-0"></div>
  </div>

  <!-- Mobile sidebar overlay -->
  <div id="mobileSidebar" class="hidden fixed inset-0 z-[80]">
    <div id="mobileBackdrop" class="absolute inset-0 bg-slate-900/40"></div>
    <div id="mobilePanel" class="absolute left-0 top-0 bottom-0 w-[18rem] -translate-x-full transition-transform duration-200 glass p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl gradient-accent grid place-items-center text-white font-bold">IH</div>
          <div>
            <div class="font-extrabold leading-tight">IntelliHRTrack</div>
            <div class="text-xs text-slate-500 dark:text-slate-300">Employee Portal</div>
          </div>
        </div>
        <button id="closeMobile" class="p-2 rounded-lg hover:bg-white/30 dark:hover:bg-white/10 ripple">
          <iconify-icon icon="ph:x-bold"></iconify-icon>
        </button>
      </div>

      <div class="mt-4 neon-divider"></div>

      <div id="mobileNavContent" class="mt-4"></div>

      <div class="mt-4 neon-divider"></div>

      <div class="mt-4 flex gap-2">
        <button id="themeToggleMobile" class="flex-1 px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">
          Toggle Theme
        </button>
        <button id="customizeLayoutMobile" class="flex-1 px-3 py-2 rounded-xl gradient-accent text-white ripple">
          Customize
        </button>
      </div>
    </div>
  </div>

  <!-- Desktop sidebar -->
  <aside data-resizable class="hidden lg:block fixed left-0 top-0 bottom-0 w-72 p-4">
    {% include "employee/_sidebar_employee.html" %}
  </aside>

  <!-- Main -->
  <main data-shift class="min-h-screen lg:ml-72 p-4 sm:p-6 lg:p-8">
    <!-- Top bar -->
    <div class="mb-6 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <button id="mobileMenuFab" class="lg:hidden px-3 py-2 rounded-xl glass ripple">
          <iconify-icon icon="ph:list-bold"></iconify-icon>
        </button>
        <div>
          <div class="text-xs text-slate-500 dark:text-slate-400">Employee Portal</div>
          <div class="text-lg font-extrabold tracking-tight">{% block page_title %}Dashboard{% endblock %}</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-2 rounded-xl glass ripple">
          <span class="hidden sm:inline">Theme</span>
          <iconify-icon icon="ph:moon-stars-duotone" class="ml-1"></iconify-icon>
        </button>

        <button id="customizeLayout" class="px-3 py-2 rounded-xl gradient-accent text-white ripple">
          Customize
        </button>
      </div>
    </div>

    {% block content %}{% endblock %}

    <footer class="mt-10 pb-6 text-center text-xs text-slate-500 dark:text-slate-400">
      © IntelliHRTrack • Employee Portal
    </footer>
  </main>

  <!-- Settings Modal -->
  <div id="settingsPanel" class="hidden fixed inset-0 z-[85] items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/40"></div>
    <div class="relative w-full max-w-xl glass rounded-3xl p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-extrabold">Customize Layout</h3>
        <button id="closeSettings" class="p-2 rounded-lg hover:bg-white/30 dark:hover:bg-white/10 ripple">
          <iconify-icon icon="ph:x-bold"></iconify-icon>
        </button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-semibold mb-2">Accent</div>
          <div class="flex flex-wrap gap-2">
            <button data-accent="teal" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Teal</button>
            <button data-accent="purple" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Purple</button>
            <button data-accent="rose" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Rose</button>
            <button data-accent="amber" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Amber</button>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-semibold mb-2">Background</div>
          <div class="flex gap-2">
            <button data-bg="gradient" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Gradient</button>
            <button data-bg="image" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Image</button>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-semibold mb-2">Glass Intensity</div>
          <input id="glassIntensity" type="range" min="0.35" max="0.85" step="0.01" value="0.60" class="w-full">
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-semibold mb-2">Sidebar Width</div>
          <div class="flex gap-2">
            <button data-sidebar="narrow" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Narrow</button>
            <button data-sidebar="default" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Default</button>
            <button data-sidebar="wide" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">Wide</button>
          </div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="resetSettings" class="px-4 py-2 rounded-xl bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/10 ripple">
          Reset
        </button>
        <button id="saveSettings" class="px-4 py-2 rounded-xl gradient-accent text-white ripple">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost" class="fixed top-4 right-4 grid gap-2 z-[95] pointer-events-none"></div>

  <script>
    // ---------------- THEME + PREFS ----------------
    const STORAGE_PREFS = 'ih_prefs';
    const THEME_KEY_A = 'ih_theme';
    const THEME_KEY_B = 'iht_theme_v1';

    function getPrefs(){
      try { return JSON.parse(localStorage.getItem(STORAGE_PREFS)) || {}; }
      catch { return {}; }
    }
    function setPrefs(p){ localStorage.setItem(STORAGE_PREFS, JSON.stringify(p)); }

    function setThemeMode(mode){
      if(mode === 'dark') document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      localStorage.setItem(THEME_KEY_A, mode);
      localStorage.setItem(THEME_KEY_B, mode);
    }

    function applyGlass(val){
      const a = parseFloat(val || '0.60');
      document.documentElement.style.setProperty('--card-bg', `rgba(255,255,255,${a})`);
      document.documentElement.style.setProperty('--card-border', `rgba(255,255,255,${Math.max(0, Math.min(1, a*0.6))})`);
    }

    function applySidebar(size){
      const map = { narrow:'14rem', default:'18rem', wide:'22rem' };
      document.documentElement.style.setProperty('--sidebar', map[size] || map.default);
    }

    function applyPrefs(p){
      if(p.accent) document.documentElement.setAttribute('data-accent', p.accent);
      if(p.bg) document.documentElement.setAttribute('data-bg', p.bg);
      if(p.glass) applyGlass(p.glass);
      if(p.sidebar) applySidebar(p.sidebar);
    }

    // init from storage
    const savedTheme = localStorage.getItem(THEME_KEY_A) || localStorage.getItem(THEME_KEY_B) || 'light';
    setThemeMode(savedTheme);
    const prefs = getPrefs();
    applyPrefs(prefs);

    // ---------------- UI HELPERS ----------------
    const toastHost = document.getElementById('toastHost');
    function showToast(msg, type='info', duration=2200){
      const t = document.createElement('div');
      t.className = `pointer-events-auto min-w-[220px] max-w-[360px] px-3 py-2 rounded-xl border border-white/30 shadow-lg glass`;
      t.innerHTML = `<div class="text-sm">${msg}</div>`;
      toastHost.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-6px)'; setTimeout(()=>t.remove(), 250); }, duration);
    }

    // Top progress
    const topProgress = document.getElementById('topProgress');
    function progressStart(){
      topProgress.style.transition='none';
      topProgress.style.width='0';
      topProgress.style.opacity='1';
      requestAnimationFrame(()=>{ topProgress.style.transition='width .8s ease'; topProgress.style.width='75%'; });
    }
    function progressDone(){
      topProgress.style.width='100%';
      setTimeout(()=>{ topProgress.style.opacity='0'; topProgress.style.width='0'; }, 350);
    }

    // ---------------- SIDEBAR ACTIVE LINK ----------------
    (function(){
      try{
        const current = location.pathname;
        document.querySelectorAll('aside nav a[href]').forEach(a=>{
          const href = a.getAttribute('href') || '';
          if(href && current.startsWith(href)){
            a.classList.add('ring','ring-white/30','bg-white/30','dark:bg-white/10');
            a.setAttribute('aria-current','page');
          }
        });
      }catch(e){}
    })();

    // ---------------- DESKTOP THEME/SETTINGS ----------------
    document.getElementById('themeToggle')?.addEventListener('click', ()=>{
      setThemeMode(document.documentElement.classList.contains('dark') ? 'light' : 'dark');
    });

    const settingsPanel = document.getElementById('settingsPanel');
    const openSettingsBtn = document.getElementById('customizeLayout');
    const closeSettingsBtn = document.getElementById('closeSettings');

    function openSettings(){
      settingsPanel.classList.remove('hidden');
      settingsPanel.classList.add('flex');
      // hydrate controls
      const p = getPrefs();
      document.getElementById('glassIntensity').value = p.glass || '0.60';
    }
    function closeSettings(){
      settingsPanel.classList.add('hidden');
      settingsPanel.classList.remove('flex');
    }

    openSettingsBtn?.addEventListener('click', openSettings);
    closeSettingsBtn?.addEventListener('click', closeSettings);
    settingsPanel?.addEventListener('click', (e)=>{ if(e.target === settingsPanel) closeSettings(); });

    // settings buttons
    document.querySelectorAll('#settingsPanel [data-accent]').forEach(b=>{
      b.addEventListener('click', ()=> document.documentElement.setAttribute('data-accent', b.dataset.accent));
    });
    document.querySelectorAll('#settingsPanel [data-bg]').forEach(b=>{
      b.addEventListener('click', ()=> document.documentElement.setAttribute('data-bg', b.dataset.bg));
    });
    document.querySelectorAll('#settingsPanel [data-sidebar]').forEach(b=>{
      b.addEventListener('click', ()=> applySidebar(b.dataset.sidebar));
    });
    document.getElementById('glassIntensity')?.addEventListener('input', (e)=> applyGlass(e.target.value));

    document.getElementById('saveSettings')?.addEventListener('click', ()=>{
      const p = getPrefs();
      const next = {
        ...p,
        accent: document.documentElement.getAttribute('data-accent') || 'teal',
        bg: document.documentElement.getAttribute('data-bg') || 'gradient',
        glass: document.getElementById('glassIntensity')?.value || '0.60',
        sidebar: (document.documentElement.style.getPropertyValue('--sidebar') || '').includes('22') ? 'wide' :
                 (document.documentElement.style.getPropertyValue('--sidebar') || '').includes('14') ? 'narrow' : 'default',
      };
      setPrefs(next);
      applyPrefs(next);
      closeSettings();
      showToast('Preferences saved', 'success');
    });

    document.getElementById('resetSettings')?.addEventListener('click', ()=>{
      const next = { accent:'teal', bg:'gradient', glass:'0.60', sidebar:'default' };
      setPrefs(next);
      applyPrefs(next);
      showToast('Preferences reset', 'info');
    });

    // ---------------- MOBILE SIDEBAR ----------------
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobilePanel = document.getElementById('mobilePanel');
    const mobileBackdrop = document.getElementById('mobileBackdrop');
    const closeMobileBtn = document.getElementById('closeMobile');
    const mobileFab = document.getElementById('mobileMenuFab');

    function openMobile(){
      const deskNav = document.querySelector('aside nav');
      const mobileNavContent = document.getElementById('mobileNavContent');
      if(deskNav && mobileNavContent){
        mobileNavContent.innerHTML = '';
        mobileNavContent.appendChild(deskNav.cloneNode(true));
      }
      mobileSidebar.classList.remove('hidden');
      setTimeout(()=> mobilePanel.classList.remove('-translate-x-full'), 10);
    }
    function closeMobile(){
      mobilePanel.classList.add('-translate-x-full');
      setTimeout(()=> mobileSidebar.classList.add('hidden'), 200);
    }

    mobileFab?.addEventListener('click', openMobile);
    mobileBackdrop?.addEventListener('click', closeMobile);
    closeMobileBtn?.addEventListener('click', closeMobile);

    document.getElementById('themeToggleMobile')?.addEventListener('click', ()=>{
      setThemeMode(document.documentElement.classList.contains('dark') ? 'light' : 'dark');
    });
    document.getElementById('customizeLayoutMobile')?.addEventListener('click', ()=>{
      closeMobile();
      openSettings();
    });

  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
