{% extends 'admin/base_admin.html' %}

{% block title %}Payroll & Finance • IntelliHRTrack - MIMAROPA{% endblock %}

{% block extra_head %}
<style>
    html, body { height: 100%; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.76)); backdrop-filter: blur(10px); }
    .glass-dark { background: linear-gradient(180deg, rgba(31,41,55,0.72), rgba(31,41,55,0.64)); }
    .neon-divider { height: 1px; background: linear-gradient(90deg, rgba(245,158,11,0), rgba(245,158,11,.6), rgba(245,158,11,0)); }
    .topbar-progress { position: fixed; left: 0; top: 0; height: 3px; width: 0; z-index: 100; background: linear-gradient(90deg, #f59e0b, #fb923c, #f59e0b); box-shadow: 0 0 12px rgba(251,146,60,.65); transition: width .45s ease; }
    .fancy-scroll::-webkit-scrollbar { height:10px; width:10px; }
    .fancy-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #f59e0b, #fb923c); border-radius:9999px; }
    .fancy-scroll::-webkit-scrollbar-track { background: transparent; }
    :root { --accent:#14b8a6; --accent-to:#0ea5a0; --card-bg: rgba(255,255,255,0.6); --card-border: rgba(255,255,255,0.35); }
    html[data-accent="teal"] { --accent:#14b8a6; --accent-to:#0ea5a0; }
    html[data-accent="purple"] { --accent:#8b5cf6; --accent-to:#7c3aed; }
    html[data-accent="rose"] { --accent:#f43f5e; --accent-to:#e11d48; }
    html[data-accent="amber"] { --accent:#f59e0b; --accent-to:#d97706; }
    .gradient-accent { background-image: linear-gradient(135deg, var(--accent), var(--accent-to)); }
    .text-accent { color: var(--accent); }
    .bg-accent { background-color: var(--accent); }
    .shadow-glow { box-shadow: 0 10px 30px -5px rgba(245,158,11,0.35), 0 8px 16px -8px rgba(59,130,246,0.25); }
    .big-scroll { scrollbar-width:auto; scrollbar-color: var(--accent) transparent; }
    .big-scroll::-webkit-scrollbar { width:16px; height:16px; }
    .big-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent), var(--accent-to)); border-radius:12px; border:3px solid transparent; background-clip: content-box; }
    .dark aside[data-resizable] .glass { background: linear-gradient(180deg, rgba(31,41,55,0.72), rgba(31,41,55,0.64)); }
    aside[data-resizable] .glass { border: 1px solid rgba(255,255,255,0.35); }
    .dark aside[data-resizable] .glass { border-color: rgba(71,85,105,0.6); }
    #sideNavList a { font-size: 0.95rem; line-height: 1.6; }
    #sideNavList a iconify-icon { font-size: 1.05rem; }
    aside[data-resizable] nav a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 0.75rem; }
    aside[data-resizable] nav a[aria-current="page"] {
        background-image: linear-gradient(135deg, var(--accent), var(--accent-to));
        color: #fff !important;
        box-shadow: 0 10px 25px -8px rgba(20,184,166,.45);
    }
    aside[data-resizable] nav a[aria-current="page"] iconify-icon { color: #fff !important; }
    #section-top.glass { border: 1px solid rgba(255,255,255,0.35); }
    .dark #section-top.glass { border-color: rgba(71,85,105,0.6); background: linear-gradient(180deg, rgba(31,41,55,0.72), rgba(31,41,55,0.64)); }
    #section-top .text-xs.glass { font-size: 0.85rem; line-height: 1.5; }
    #section-top button, #section-top a { font-size: 0.95rem; }
    #section-top button:focus-visible, #section-top a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 0.75rem; }
    .dark #section-top .rounded-xl.glass { border-color: rgba(71,85,105,0.6); }
</style>
<style>
    body {
        background-color: #ffffff;
        background-image:
            radial-gradient(1200px 600px at -10% -20%, rgba(245, 158, 11, 0.18), transparent),
            radial-gradient(900px 500px at 110% 10%, rgba(251, 146, 60, 0.14), transparent);
    }
    .dark body {
        background-color: #0f172a;
        background-image:
            radial-gradient(1200px 600px at -10% -20%, rgba(245, 158, 11, 0.12), transparent),
            radial-gradient(900px 500px at 110% 10%, rgba(251, 146, 60, 0.10), transparent);
    }
</style>
<style>
    .js-only{ display:none !important }
    .payroll-tab { outline: none }
    .peso:before { content: "₱"; }
    .sticky-action-bar { position: sticky; top: 1rem; z-index: 40; }
    .dtr-watermark { position: absolute; opacity: 0.1; font-size: 4rem; font-weight: bold; transform: rotate(-45deg); pointer-events: none; user-select: none; }
    .readonly-field { background-color: #f9fafb; cursor: not-allowed; }
</style>

<!-- ✅ CSRF helper for fetch POST -->
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<!-- Top Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-2xl shadow-xl p-6 border border-white/30 dark:border-gray-700/60 hover:shadow-2xl transition-transform duration-300 hover:-translate-y-0.5">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Payroll This Month</p>
                <h3 class="text-2xl font-extrabold mt-1 peso">
                    {% if total_payroll %}{{ total_payroll|floatformat:2 }}{% else %}0.00{% endif %}
                </h3>
                <p class="text-xs text-green-600 mt-2 flex items-center"><iconify-icon icon="ph:arrow-up-right-duotone" class="mr-1"></iconify-icon>MIMAROPA Region</p>
            </div>
            <div class="p-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-lg text-white"><iconify-icon icon="ph:currency-dollar-duotone" class="text-xl"></iconify-icon></div>
        </div>
    </div>
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-2xl shadow-xl p-6 border border-white/30 dark:border-gray-700/60 hover:shadow-2xl transition-transform duration-300 hover:-translate-y-0.5">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Pending Approval</p>
                <h3 class="text-2xl font-extrabold mt-1 peso">
                    {% if pending_approval %}{{ pending_approval|floatformat:2 }}{% else %}0.00{% endif %}
                </h3>
                <p class="text-xs text-yellow-600 mt-2 flex items-center"><iconify-icon icon="ph:clock-duotone" class="mr-1"></iconify-icon>Awaiting review</p>
            </div>
            <div class="p-3 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl shadow-lg text-white"><iconify-icon icon="ph:hourglass-duotone" class="text-xl"></iconify-icon></div>
        </div>
    </div>
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-2xl shadow-xl p-6 border border-white/30 dark:border-gray-700/60 hover:shadow-2xl transition-transform duration-300 hover:-translate-y-0.5">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Attendance Deductions</p>
                <h3 class="text-2xl font-extrabold mt-1 peso">
                    {% if attendance_deductions %}{{ attendance_deductions|floatformat:2 }}{% else %}0.00{% endif %}
                </h3>
                <p class="text-xs text-red-600 mt-2 flex items-center">
                    <iconify-icon icon="ph:warning-circle-duotone" class="mr-1"></iconify-icon>
                    Late/Undertime
                </p>
            </div>
            <div class="p-3 bg-gradient-to-r from-red-500 to-red-600 rounded-xl shadow-lg text-white"><iconify-icon icon="ph:clock-afternoon-duotone" class="text-xl"></iconify-icon></div>
        </div>
    </div>
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-2xl shadow-xl p-6 border border-white/30 dark:border-gray-700/60 hover:shadow-2xl transition-transform duration-300 hover:-translate-y-0.5">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Government Contributions</p>
                <h3 class="text-2xl font-extrabold mt-1 peso">
                    {% if gov_contributions %}{{ gov_contributions|floatformat:2 }}{% else %}0.00{% endif %}
                </h3>
                <p class="text-xs text-blue-600 mt-2 flex items-center">
                    <iconify-icon icon="ph:percent-duotone" class="mr-1"></iconify-icon>
                    SSS/PhilHealth/Pag-IBIG
                </p>
            </div>
            <div class="p-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl shadow-lg text-white"><iconify-icon icon="ph:receipt-duotone" class="text-xl"></iconify-icon></div>
        </div>
    </div>
</div>

<!-- Tabs Wrapper -->
<div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-2xl shadow-xl border border-white/30 dark:border-gray-700/60 overflow-hidden">
    <div class="border-b border-white/30 dark:border-gray-700/60 overflow-x-auto">
        <nav class="flex -mb-px">
            <button id="payroll-processing-tab" class="payroll-tab py-4 px-6 text-center border-b-2 border-amber-500 text-amber-500 dark:text-amber-400 font-medium flex items-center whitespace-nowrap">
                <iconify-icon icon="ph:calculator-duotone" class="mr-2"></iconify-icon>
                Payroll Processing
            </button>
            <button id="payroll-setup-tab" class="payroll-tab py-4 px-6 text-center border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium flex items-center whitespace-nowrap">
                <iconify-icon icon="ph:gear-duotone" class="mr-2"></iconify-icon>
                Payroll Setup
            </button>
            <button id="salary-structure-tab" class="payroll-tab py-4 px-6 text-center border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium flex items-center whitespace-nowrap">
                <iconify-icon icon="ph:chart-bar-duotone" class="mr-2"></iconify-icon>
                Salary Structure
            </button>
            <button id="payroll-history-tab" class="payroll-tab py-4 px-6 text-center border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium flex items-center whitespace-nowrap">
                <iconify-icon icon="ph:clock-counter-clockwise-duotone" class="mr-2"></iconify-icon>
                Payroll History
            </button>
            <button id="financial-dashboard-tab" class="payroll-tab py-4 px-6 text-center border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium flex items-center whitespace-nowrap">
                <iconify-icon icon="ph:chart-line-up-duotone" class="mr-2"></iconify-icon>
                Financial Dashboard
            </button>
        </nav>
    </div>

    <div class="p-6">
        <!-- Payroll Processing Content (Default) -->
        <div id="payroll-processing-content" class="payroll-content">
            <!-- Sticky Action Bar -->
            <div class="sticky-action-bar bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-xl p-4 mb-6 shadow-lg border border-white/30 dark:border-gray-700/60">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h3 class="text-xl font-bold">Payroll Processing - MIMAROPA</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Process payroll for {{ employees|length|default:"0" }} employees | Government Payroll Rules Applied</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="generatePreviewBtn" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white rounded-lg flex items-center shadow-lg transition-all duration-300 hover:scale-105">
                            <iconify-icon icon="ph:play-circle-duotone" class="mr-2"></iconify-icon>
                            Generate Payroll Preview
                        </button>

                        <div class="relative group">
                            <button class="px-4 py-2 bg-white dark:bg-gray-700 border border-white/30 dark:border-gray-700/60 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg flex items-center shadow-md">
                                <iconify-icon icon="ph:printer-duotone" class="mr-2"></iconify-icon>
                                DTR Print
                            </button>
                            <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg">
                                    <iconify-icon icon="ph:printer-duotone" class="mr-2"></iconify-icon>
                                    Print DTR
                                </button>
                                <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <iconify-icon icon="ph:file-pdf-duotone" class="mr-2"></iconify-icon>
                                    Export DTR PDF
                                </button>
                                <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-lg">
                                    <iconify-icon icon="ph:file-csv-duotone" class="mr-2"></iconify-icon>
                                    Export DTR CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Branch</label>
                        <select id="branchFilter" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                            {% for branch in branches %}
                            <option value="{{ branch.id }}" {% if branch.id == selected_branch %}selected{% endif %}>{{ branch.name }}</option>
                            {% empty %}
                            <option value="">No branches</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Payroll Period</label>
                        <select id="periodFilter" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                            {% for period in payroll_periods %}
                            <option value="{{ period.id }}" {% if period.id == selected_period %}selected{% endif %}>{{ period.name }}</option>
                            {% empty %}
                            <option value="">No periods</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employment Type</label>
                        <select id="typeFilter" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                            <option value="ALL">All Types</option>
                            <option value="JO">Job Order (JO)</option>
                            <option value="COS">Contract of Service (COS)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preview Table (Initially Hidden) -->
            <div id="payrollPreview" class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-white/30 dark:border-gray-700/60 mb-6">
                <div class="px-6 py-4 border-b border-white/30 dark:border-gray-700/60 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Payroll Preview</h3>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm">Preview Mode</span>
                        <!-- ✅ added id -->
                        <button id="approveProcessBtn" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm">
                            Approve & Process
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700/60">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Base</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Premium</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">OT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Late</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Undertime</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Absences</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Deductions</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Net</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Issues</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="previewTableBody"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 border-t border-white/30 dark:border-gray-700/60 bg-gray-50 dark:bg-gray-700/30">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Employees: <span id="previewTotalEmployees">0</span></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Net Pay: <span id="previewTotalNet" class="font-bold peso">0.00</span></p>
                        </div>
                        <button id="closePreviewBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg">
                            Close Preview
                        </button>
                    </div>
                </div>
            </div>

            <!-- Employee Payroll Details -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-white/30 dark:border-gray-700/60">
                <div class="px-6 py-4 border-b border-white/30 dark:border-gray-700/60 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Employee Payroll Details</h3>
                    <div class="flex space-x-2">
                        <a href="{% url 'admin_biometrics' %}" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm flex items-center">
                            <iconify-icon icon="ph:fingerprint-duotone" class="mr-2"></iconify-icon>
                            Biometrics Integration
                        </a>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700/60">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Branch</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Attendance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Government Contributions</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Net Pay</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for employee in employees|slice:":10" %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold">
                                                {{ employee.name|first }}
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium">{{ employee.name }}</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">{{ employee.position }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full {% if employee.employment_type == 'JO' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200{% endif %}">
                                        {{ employee.employment_type }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ employee.branch_name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm">
                                        <div class="flex items-center gap-2">
                                            <span class="text-green-600">✓ {{ employee.attendance_summary.days_present|default:"0" }} days</span>
                                            <span class="text-red-600">✗ {{ employee.attendance_summary.days_absent|default:"0" }}</span>
                                        </div>
                                        {% if employee.attendance_summary.total_late_minutes > 0 %}
                                        <div class="text-xs text-amber-600">Late: {{ employee.attendance_summary.total_late_minutes }} mins</div>
                                        {% endif %}
                                        {% if employee.attendance_summary.has_missing_logs %}
                                        <div class="text-xs text-red-600">Missing logs</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <div class="space-y-1">
                                        <div>SSS: ₱{{ employee.sss_amount|default:"760" }}</div>
                                        <div>PhilHealth: ₱{{ employee.philhealth_value|default:"—" }}</div>
                                        <div>Pag-IBIG: ₱{{ employee.pagibig_amount|default:"400" }}</div>
                                        {% if employee.has_premium %}
                                        <div class="text-green-600">Premium: 20%</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-semibold peso">{{ employee.computed_payroll.net|default:"0.00" }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if employee.attendance_summary.has_missing_logs %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Issues</span>
                                    {% else %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Ready</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-lg view-dtr-btn"
                                                data-employee-id="{{ employee.id }}">
                                            <iconify-icon icon="ph:eye-duotone" class="mr-1"></iconify-icon> View DTR
                                        </button>
                                        <button class="text-amber-600 hover:text-amber-900 dark:text-amber-400 dark:hover:text-amber-300 bg-amber-50 dark:bg-amber-900/30 px-3 py-1 rounded-lg">
                                            <iconify-icon icon="ph:pencil-simple-duotone" class="mr-1"></iconify-icon> Adjust
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center">
                                    <iconify-icon icon="ph:users-duotone" class="text-4xl text-gray-400"></iconify-icon>
                                    <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-gray-100">No employees found</h3>
                                    <p class="mt-2 text-sm text-gray-500">Add employees or adjust your filters.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payroll Setup Content -->
        <div id="payroll-setup-content" class="payroll-content hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold">Payroll Setup & Configuration</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Configure MIMAROPA government payroll rules, contributions, and holiday management</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Payroll Rules Configuration -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-white/30 dark:border-gray-700/60">
                        <h3 class="text-lg font-semibold mb-4">Payroll Rules Configuration</h3>
                        <form id="payrollRulesForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tax Rate %</label>
                                    <input type="number" step="0.01" min="0" max="100"
                                           value="{{ payroll_rules.tax_rate_percent|default:'5' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Premium Rate %</label>
                                    <input type="number" step="0.01" min="0" max="100"
                                           value="{{ payroll_rules.premium_rate_percent|default:'20' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PhilHealth Default</label>
                                <div class="flex items-center gap-4 mb-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="philhealth_mode" value="percent"
                                               {% if payroll_rules.philhealth_default_mode != 'fixed' %}checked{% endif %}
                                               class="h-4 w-4 text-blue-600">
                                        <span class="ml-2 text-sm">Percentage (%)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="philhealth_mode" value="fixed"
                                               {% if payroll_rules.philhealth_default_mode == 'fixed' %}checked{% endif %}
                                               class="h-4 w-4 text-blue-600">
                                        <span class="ml-2 text-sm">Fixed Amount</span>
                                    </label>
                                </div>
                                <input type="number" step="0.01" min="0"
                                       value="{{ payroll_rules.philhealth_default_value|default:'5' }}"
                                       class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Late Penalty per Minute (₱)</label>
                                    <input type="number" step="0.01" min="0"
                                           value="{{ payroll_rules.late_penalty_per_minute|default:'1.50' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Undertime Penalty per Minute (₱)</label>
                                    <input type="number" step="0.01" min="0"
                                           value="{{ payroll_rules.undertime_penalty_per_minute|default:'2.00' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grace Minutes (Normal Days)</label>
                                    <input type="number" min="0"
                                           value="{{ payroll_rules.grace_minutes_normal|default:'15' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Flag Ceremony Cutoff</label>
                                    <input type="time"
                                           value="{{ payroll_rules.flag_ceremony_cutoff_time|default:'08:00' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox"
                                               {% if payroll_rules.lunch_break_required %}checked{% endif %}
                                               class="h-4 w-4 rounded border-gray-300 text-blue-600">
                                        <span class="ml-2 text-sm">Require Lunch Break Logs</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Daily Hours Required</label>
                                    <input type="number" step="0.5" min="0"
                                           value="{{ payroll_rules.daily_hours_required|default:'8' }}"
                                           class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm">
                                </div>
                            </div>

                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg shadow-lg">
                                    Save Payroll Rules
                                </button>
                                <button type="button" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg ml-2">
                                    Reset to Defaults
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Government Contributions -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-white/30 dark:border-gray-700/60">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Government Contributions (Employee-Specific)</h3>
                            <button class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm">
                                Save Changes
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700/60">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Employee</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">SSS Amount (Min ₱760)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Pag-IBIG (Min ₱400)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">PhilHealth</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Premium</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    {% for employee in employees|slice:":5" %}
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">{{ employee.name }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <input type="number" min="760" step="0.01"
                                                   value="{{ employee.sss_amount|default:'760' }}"
                                                   class="w-full rounded border border-gray-300 px-2 py-1 text-sm">
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <input type="number" min="400" step="0.01"
                                                   value="{{ employee.pagibig_amount|default:'400' }}"
                                                   class="w-full rounded border border-gray-300 px-2 py-1 text-sm">
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="space-y-1">
                                                <select class="w-full rounded border border-gray-300 px-2 py-1 text-sm">
                                                    <option value="percent" {% if employee.philhealth_mode != 'fixed' %}selected{% endif %}>%</option>
                                                    <option value="fixed" {% if employee.philhealth_mode == 'fixed' %}selected{% endif %}>Fixed</option>
                                                </select>
                                                <input type="number" step="0.01" min="0"
                                                       value="{{ employee.philhealth_value|default:'5' }}"
                                                       class="w-full rounded border border-gray-300 px-2 py-1 text-sm mt-1">
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <label class="inline-flex items-center">
                                                <input type="checkbox" {% if employee.has_premium %}checked{% endif %}
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600">
                                                <span class="ml-2 text-sm">Apply Premium</span>
                                            </label>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Holiday & Suspension Manager -->
                <div class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-white/30 dark:border-gray-700/60">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Holiday & Suspension Manager</h3>
                            <button class="px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm" id="addHolidayBtn">
                                Add Holiday
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            {% for holiday in holidays %}
                            <div class="p-3 rounded-lg border {% if holiday.type == 'holiday' %}border-green-200 bg-green-50 dark:border-green-700 dark:bg-green-900/30{% else %}border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/30{% endif %}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium">{{ holiday.name }}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ holiday.date|date:"F d, Y" }}</p>
                                        <p class="text-xs mt-1">
                                            <span class="px-1.5 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700">
                                                {{ holiday.get_type_display }}
                                            </span>
                                            <span class="ml-2">{{ holiday.get_scope_display }}</span>
                                        </p>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600">
                                        <iconify-icon icon="ph:trash-duotone"></iconify-icon>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    Impact: {% if holiday.type == 'holiday' %}JO - No Pay, COS - Paid{% else %}Both - No Work No Pay{% endif %}
                                </p>
                            </div>
                            {% empty %}
                            <div class="text-center py-8">
                                <iconify-icon icon="ph:calendar-blank-duotone" class="text-3xl text-gray-400"></iconify-icon>
                                <p class="mt-2 text-sm text-gray-500">No holidays or suspensions configured</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Audit Trail -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-white/30 dark:border-gray-700/60">
                        <h3 class="text-lg font-semibold mb-4">Audit Trail</h3>
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            {% for batch in payroll_batches|slice:":5" %}
                            <div class="border-l-2 border-blue-500 pl-3">
                                <p class="text-sm font-medium">{{ batch.name }}</p>
                                <p class="text-xs text-gray-500">{{ batch.processed_by }} • {{ batch.processed_at|date:"M d, Y H:i" }}</p>
                                <p class="text-xs mt-1">
                                    <span class="px-1.5 py-0.5 rounded-full {% if batch.status == 'completed' %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ batch.get_status_display }}
                                    </span>
                                </p>
                            </div>
                            {% empty %}
                            <p class="text-sm text-gray-500 text-center py-4">No payroll batches processed yet</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Remaining tabs -->
        <div id="salary-structure-content" class="payroll-content hidden">
            <div class="text-center py-12">
                <iconify-icon icon="ph:chart-bar-duotone" class="text-4xl text-gray-400"></iconify-icon>
                <h3 class="mt-4 text-lg font-medium">Government Salary Structure</h3>
                <p class="text-sm text-gray-500 mt-2">Configured via Payroll Setup rules</p>
            </div>
        </div>

        <div id="payroll-history-content" class="payroll-content hidden">
            <div class="text-center py-12">
                <iconify-icon icon="ph:clock-counter-clockwise-duotone" class="text-4xl text-gray-400"></iconify-icon>
                <h3 class="mt-4 text-lg font-medium">Payroll History</h3>
                <p class="text-sm text-gray-500 mt-2">View audit trail in Payroll Setup tab</p>
            </div>
        </div>

        <div id="financial-dashboard-content" class="payroll-content hidden">
            <div class="text-center py-12">
                <iconify-icon icon="ph:chart-line-up-duotone" class="text-4xl text-gray-400"></iconify-icon>
                <h3 class="mt-4 text-lg font-medium">Financial Dashboard</h3>
                <p class="text-sm text-gray-500 mt-2">Available in next update</p>
            </div>
        </div>
    </div>
</div>

<!-- Holiday/Suspension Modal -->
<div id="holidayModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white dark:bg-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Add Holiday/Suspension</h3>
            <button id="closeHolidayModal" class="text-gray-400 hover:text-gray-600">
                <iconify-icon icon="ph:x-duotone"></iconify-icon>
            </button>
        </div>
        <form id="holidayForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Date</label>
                <input type="date" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Name</label>
                <input type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="e.g., Independence Day">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Type</label>
                <select class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                    <option value="holiday">Regular Holiday</option>
                    <option value="suspension">Work Suspension</option>
                    <option value="special">Special Non-Working Day</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Scope</label>
                <select class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                    <option value="nationwide">Nationwide</option>
                    <option value="branch">Specific Branch</option>
                    <option value="region">MIMAROPA Region</option>
                </select>
            </div>
            <div id="branchSelection" class="hidden">
                <label class="block text-sm font-medium mb-1">Branch</label>
                <select class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                    {% for branch in branches %}
                    <option value="{{ branch.id }}">{{ branch.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Notes</label>
                <textarea rows="3" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="Impact on JO/COS payroll..."></textarea>
            </div>
            <div class="flex justify-end gap-2 pt-4">
                <button type="button" id="cancelHoliday" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">Save Holiday</button>
            </div>
        </form>
    </div>
</div>

<!-- DTR View Modal -->
<div id="dtrModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-xl bg-white dark:bg-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Daily Time Record (DTR)</h3>
            <div class="flex items-center gap-2">
                <iconify-icon icon="ph:lock-duotone" class="text-amber-500"></iconify-icon>
                <span class="text-sm text-gray-500">SYSTEM GENERATED - NOT EDITABLE</span>
                <button id="closeDtrModal" class="ml-4 text-gray-400 hover:text-gray-600">
                    <iconify-icon icon="ph:x-duotone"></iconify-icon>
                </button>
            </div>
        </div>
        <div class="relative border rounded-lg p-4">
            <div class="dtr-watermark">SYSTEM GENERATED</div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium">Date</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Day</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Time In</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Time Out</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Lunch In</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Lunch Out</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Total Hours</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Late (mins)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Undertime (mins)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dtrTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg mr-2">Print</button>
            <button class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">Export PDF</button>
        </div>
    </div>
</div>

<!-- Feature Highlights -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
    <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-xl p-6 text-white hover:shadow-2xl transition duration-300">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Government Compliance</h3>
            <iconify-icon icon="ph:shield-check-duotone" class="text-2xl"></iconify-icon>
        </div>
        <p class="text-amber-100 mb-4">SSS, PhilHealth, Pag-IBIG, Tax calculations compliant with Philippine government regulations.</p>
        <button class="text-sm bg-white text-amber-600 hover:bg-amber-50 px-3 py-2 rounded-lg font-medium inline-flex items-center shadow-md" onclick="switchTab('payroll-setup-tab')">
            <iconify-icon icon="ph:gear-duotone" class="mr-2"></iconify-icon>
            Configure Rules
        </button>
    </div>
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white hover:shadow-2xl transition duration-300">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Attendance Integration</h3>
            <iconify-icon icon="ph:fingerprint-duotone" class="text-2xl"></iconify-icon>
        </div>
        <p class="text-blue-100 mb-4">Automatic payroll computation from biometrics attendance with JO/COS rules.</p>
        <a href="{% url 'admin_biometrics' %}" class="text-sm bg-white text-blue-600 hover:bg-blue-50 px-3 py-2 rounded-lg font-medium inline-flex items-center shadow-md">
            <iconify-icon icon="ph:link-duotone" class="mr-2"></iconify-icon>
            View Attendance
        </a>
    </div>
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-xl p-6 text-white hover:shadow-2xl transition duration-300">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Audit Trail</h3>
            <iconify-icon icon="ph:file-text-duotone" class="text-2xl"></iconify-icon>
        </div>
        <p class="text-green-100 mb-4">Tamper-resistant DTRs with system-generated watermarks and complete audit logs.</p>
        <button class="text-sm bg-white text-green-700 hover:bg-green-50 px-3 py-2 rounded-lg font-medium inline-flex items-center shadow-md" onclick="switchTab('payroll-setup-tab')">
            <iconify-icon icon="ph:eye-duotone" class="mr-2"></iconify-icon>
            View Audit Trail
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ----------------------------
    // Tabs
    // ----------------------------
    const tabMap = [
        { tabId: 'payroll-processing-tab', contentId: 'payroll-processing-content' },
        { tabId: 'payroll-setup-tab', contentId: 'payroll-setup-content' },
        { tabId: 'salary-structure-tab', contentId: 'salary-structure-content' },
        { tabId: 'payroll-history-tab', contentId: 'payroll-history-content' },
        { tabId: 'financial-dashboard-tab', contentId: 'financial-dashboard-content' },
    ];

    function setTabStyles(btn, active) {
        if (!btn) return;
        btn.classList.toggle('border-amber-500', active);
        btn.classList.toggle('text-amber-500', active);
        btn.classList.toggle('dark:text-amber-400', active);
        btn.classList.toggle('border-transparent', !active);
        btn.classList.toggle('text-gray-500', !active);
        btn.classList.toggle('dark:text-gray-400', !active);
    }

    function switchTab(targetTabId) {
        tabMap.forEach(({ tabId, contentId }) => {
            const btn = document.getElementById(tabId);
            const content = document.getElementById(contentId);
            const isActive = tabId === targetTabId;
            setTabStyles(btn, isActive);
            if (content) content.classList.toggle('hidden', !isActive);
        });
    }

    tabMap.forEach(({ tabId }) => {
        const btn = document.getElementById(tabId);
        btn && btn.addEventListener('click', () => switchTab(tabId));
    });

    // ----------------------------
    // Small helpers
    // ----------------------------
    function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    }

    function peso(n) {
        const num = Number(n || 0);
        return num.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function setBusy(btn, busy, labelIdle) {
        if (!btn) return;
        btn.disabled = !!busy;
        btn.classList.toggle('opacity-70', !!busy);
        btn.classList.toggle('cursor-not-allowed', !!busy);
        if (labelIdle) btn.dataset.labelIdle = labelIdle;
        if (busy) {
            btn.dataset.labelWas = btn.innerHTML;
            btn.innerHTML = `<span class="inline-flex items-center gap-2"><span class="animate-spin h-4 w-4 border-2 border-white/70 border-t-transparent rounded-full"></span>Loading…</span>`;
        } else if (btn.dataset.labelWas) {
            btn.innerHTML = btn.dataset.labelWas;
            delete btn.dataset.labelWas;
        }
    }

    function showToast(message, type = "info") {
        // lightweight: alert for now (you can replace with a fancy toast later)
        if (type === "error") return alert("Error: " + message);
        alert(message);
    }

    // ----------------------------
    // Holiday Modal (unchanged)
    // ----------------------------
    const holidayModal = document.getElementById('holidayModal');
    const addHolidayBtn = document.getElementById('addHolidayBtn');
    const closeHolidayModal = document.getElementById('closeHolidayModal');
    const cancelHoliday = document.getElementById('cancelHoliday');
    const scopeSelect = holidayModal?.querySelector('select');

    addHolidayBtn?.addEventListener('click', () => holidayModal.classList.remove('hidden'));
    [closeHolidayModal, cancelHoliday].forEach(btn => {
        btn?.addEventListener('click', () => holidayModal.classList.add('hidden'));
    });

    scopeSelect?.addEventListener('change', (e) => {
        const branchSelection = document.getElementById('branchSelection');
        if (e.target.value === 'branch') branchSelection.classList.remove('hidden');
        else branchSelection.classList.add('hidden');
    });

    // ----------------------------
    // DTR Modal + Fetch real DTR
    // ----------------------------
    const dtrModal = document.getElementById('dtrModal');
    const closeDtrModal = document.getElementById('closeDtrModal');
    closeDtrModal?.addEventListener('click', () => dtrModal.classList.add('hidden'));

    const periodFilter = document.getElementById('periodFilter');

    async function loadDTR(profileId) {
        const periodId = periodFilter?.value || '';
        const url = `/admin-ui/payroll/dtr/${profileId}/?period=${encodeURIComponent(periodId)}`;

        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (!res.ok || !data.ok) {
            throw new Error(data.error || "Failed to load DTR");
        }
        return data;
    }

    function renderDTR(rows) {
        const tbody = document.getElementById('dtrTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';

        rows.forEach(record => {
            const row = document.createElement('tr');
            const lateCls = Number(record.late || 0) > 0 ? 'text-red-600' : '';
            const underCls = Number(record.undertime || 0) > 0 ? 'text-amber-600' : '';

            const statusBadge =
                (record.status === 'Present')
                    ? 'bg-green-100 text-green-800'
                    : (record.status || '').toLowerCase().includes('missing')
                        ? 'bg-yellow-100 text-yellow-800'
                        : 'bg-red-100 text-red-800';

            row.innerHTML = `
                <td class="px-4 py-2 text-sm">${record.date || ''}</td>
                <td class="px-4 py-2 text-sm">${record.day || ''}</td>
                <td class="px-4 py-2 text-sm">${record.timeIn || ''}</td>
                <td class="px-4 py-2 text-sm">${record.timeOut || ''}</td>
                <td class="px-4 py-2 text-sm">${record.lunchIn || ''}</td>
                <td class="px-4 py-2 text-sm">${record.lunchOut || ''}</td>
                <td class="px-4 py-2 text-sm">${record.totalHours ?? ''}</td>
                <td class="px-4 py-2 text-sm ${lateCls}">${record.late ?? 0}</td>
                <td class="px-4 py-2 text-sm ${underCls}">${record.undertime ?? 0}</td>
                <td class="px-4 py-2 text-sm">
                    <span class="px-2 py-1 rounded-full text-xs ${statusBadge}">
                        ${record.status || ''}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Bind View DTR buttons
    document.querySelectorAll('.view-dtr-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const profileId = this.getAttribute('data-employee-id');
            if (!profileId) return;

            try {
                setBusy(this, true);
                const data = await loadDTR(profileId);
                renderDTR(data.rows || []);
                dtrModal.classList.remove('hidden');
            } catch (err) {
                showToast(err.message || "Failed to load DTR", "error");
            } finally {
                setBusy(this, false);
            }
        });
    });

    // ----------------------------
    // Preview + Fetch real Preview
    // ----------------------------
    const generatePreviewBtn = document.getElementById('generatePreviewBtn');
    const payrollPreview = document.getElementById('payrollPreview');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const approveProcessBtn = document.getElementById('approveProcessBtn');

    const branchFilter = document.getElementById('branchFilter');
    const typeFilter = document.getElementById('typeFilter');

    async function loadPreview() {
        const branchId = branchFilter?.value || '';
        const periodId = periodFilter?.value || '';
        const type = typeFilter?.value || 'ALL';

        const url = `/admin-ui/payroll/preview/?branch=${encodeURIComponent(branchId)}&period=${encodeURIComponent(periodId)}&type=${encodeURIComponent(type)}`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (!res.ok || !data.ok) {
            throw new Error(data.error || "Failed to generate preview");
        }
        return data;
    }

    function renderPreview(employees) {
        const tbody = document.getElementById('previewTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';
        let totalNet = 0;

        employees.forEach(emp => {
            const net = Number(emp.net || 0);
            totalNet += net;

            const typeBadge = (emp.type === 'JO')
                ? 'bg-yellow-100 text-yellow-800'
                : 'bg-blue-100 text-blue-800';

            const issuesHtml = emp.issues
                ? `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">${emp.issues}</span>`
                : '<span class="text-green-600">✓</span>';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium">${emp.name || ''}</td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-2 py-1 text-xs rounded-full ${typeBadge}">
                        ${emp.type || ''}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm peso">${peso(emp.base)}</td>
                <td class="px-6 py-4 text-sm peso">${peso(emp.premium)}</td>
                <td class="px-6 py-4 text-sm peso">${peso(emp.ot)}</td>
                <td class="px-6 py-4 text-sm ${Number(emp.late||0) > 0 ? 'text-red-600' : ''}">${emp.late ?? 0} mins</td>
                <td class="px-6 py-4 text-sm ${Number(emp.undertime||0) > 0 ? 'text-amber-600' : ''}">${emp.undertime ?? 0} mins</td>
                <td class="px-6 py-4 text-sm">${emp.absences ?? 0}</td>
                <td class="px-6 py-4 text-sm peso text-red-600">${peso(emp.deductions)}</td>
                <td class="px-6 py-4 text-sm font-semibold peso">${peso(emp.net)}</td>
                <td class="px-6 py-4 text-sm">${issuesHtml}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('previewTotalEmployees').textContent = employees.length;
        document.getElementById('previewTotalNet').textContent = peso(totalNet);

        payrollPreview.classList.remove('hidden');
        payrollPreview.scrollIntoView({ behavior: 'smooth' });
    }

    generatePreviewBtn?.addEventListener('click', async () => {
        try {
            setBusy(generatePreviewBtn, true);
            const data = await loadPreview();
            renderPreview(data.employees || []);
        } catch (err) {
            showToast(err.message || "Failed to generate preview", "error");
        } finally {
            setBusy(generatePreviewBtn, false);
        }
    });

    closePreviewBtn?.addEventListener('click', () => payrollPreview.classList.add('hidden'));

    // ✅ Approve & Process (POST)
    approveProcessBtn?.addEventListener('click', async () => {
        const branchId = branchFilter?.value || '';
        const periodId = periodFilter?.value || '';
        const type = typeFilter?.value || 'ALL';

        if (!branchId || !periodId) {
            return showToast("Please select Branch and Payroll Period first.", "error");
        }

        try {
            setBusy(approveProcessBtn, true);

            const body = new URLSearchParams();
            body.set("branch", branchId);
            body.set("period", periodId);
            body.set("type", type);

            const res = await fetch("/admin-ui/payroll/process/", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
                    "X-CSRFToken": getCsrfToken(),
                },
                body: body.toString(),
            });

            const data = await res.json();
            if (!res.ok || !data.ok) {
                throw new Error(data.error || "Failed to process payroll");
            }

            showToast(`Payroll processed! Batch: ${data.batch?.name || ''}`, "info");
            // Refresh the page to update top cards + audit trail
            window.location.reload();
        } catch (err) {
            showToast(err.message || "Failed to process payroll", "error");
        } finally {
            setBusy(approveProcessBtn, false);
        }
    });

    // ----------------------------
    // Filter persistence + reload page with query params
    // ----------------------------
    function reloadWithFilters() {
        const params = new URLSearchParams(window.location.search);
        if (branchFilter?.value) params.set("branch", branchFilter.value);
        if (periodFilter?.value) params.set("period", periodFilter.value);
        if (typeFilter?.value) params.set("type", typeFilter.value);
        window.location.search = params.toString();
    }

    branchFilter?.addEventListener('change', () => {
        localStorage.setItem('payroll_selected_branch', branchFilter.value);
        reloadWithFilters();
    });

    periodFilter?.addEventListener('change', () => reloadWithFilters());
    typeFilter?.addEventListener('change', () => reloadWithFilters());

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        const savedBranch = localStorage.getItem('payroll_selected_branch');
        if (savedBranch && branchFilter) branchFilter.value = savedBranch;
        switchTab('payroll-processing-tab');
    });
</script>
{% endblock %}
