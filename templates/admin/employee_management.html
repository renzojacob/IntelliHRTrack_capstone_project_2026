{% extends 'admin/base_admin.html' %}

{% block title %}intellihrtrack — employee management{% endblock %}

{% block extra_head %}
<style>
  .status-badge {
    padding: .25rem .75rem;
    border-radius: 9999px;
    font-size: .75rem;
    font-weight: 600;
  }
  .status-pending {
    background: rgba(245,158,11,.15);
    color: rgb(202,138,4);
  }
  .status-approved {
    background: rgba(34,197,94,.15);
    color: rgb(22,163,74);
  }

  .pill {
    padding:.25rem .6rem;
    border-radius:9999px;
    font-size:.75rem;
    font-weight:600;
  }
  .pill-cos {
    background: rgba(59,130,246,.15);
    color: rgb(37,99,235);
  }
  .pill-jo {
    background: rgba(139,92,246,.15);
    color: rgb(124,58,237);
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen p-6 space-y-6">

  <!-- HEADER -->
  <div class="glass rounded-3xl p-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-extrabold">Employee Management</h1>
      <p class="text-sm text-slate-500">
        approve accounts and manage employee profiles
      </p>
    </div>

    <a href="{% url 'signup_ui' %}"
       class="px-4 py-2 rounded-xl text-white bg-teal-600 hover:bg-teal-700 flex items-center gap-2">
      <iconify-icon icon="ph:user-plus-duotone"></iconify-icon>
      signup page
    </a>
  </div>

  <!-- SUMMARY -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="glass rounded-xl p-4">
      <div class="text-xs text-slate-500">Pending</div>
      <div class="text-2xl font-bold">{{ pending_profiles|length }}</div>
    </div>
    <div class="glass rounded-xl p-4">
      <div class="text-xs text-slate-500">Approved</div>
      <div class="text-2xl font-bold">{{ approved_profiles|length }}</div>
    </div>
    <div class="glass rounded-xl p-4">
      <div class="text-xs text-slate-500">Your Branch</div>
      <div class="text-lg font-semibold">
        {% if request.user.is_superuser %}
          All Branches
        {% else %}
          {{ request.user.profile.branch|default:"—" }}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- EMPLOYEE TABLE (APPROVE/REJECT) -->
  <div class="glass rounded-2xl p-4 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-xs uppercase text-slate-500 border-b">
        <tr>
          <th class="px-3 py-2 text-left">Username</th>
          <th class="px-3 py-2 text-left">Email</th>
          <th class="px-3 py-2 text-left">Branch</th>
          <th class="px-3 py-2 text-left">Department</th>
          <th class="px-3 py-2 text-left">Job Type</th>
          <th class="px-3 py-2 text-left">Status</th>
          <th class="px-3 py-2 text-left">Created</th>
          <th class="px-3 py-2 text-right">Action</th>
        </tr>
      </thead>

      <tbody class="divide-y">

        <!-- PENDING -->
        <tr class="bg-amber-50/40">
          <td colspan="8" class="px-3 py-2 font-semibold text-amber-700">
            Pending Accounts
          </td>
        </tr>

        {% for p in pending_profiles %}
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2 font-medium">{{ p.user.username }}</td>
          <td class="px-3 py-2">{{ p.user.email|default:"—" }}</td>
          <td class="px-3 py-2">{{ p.branch|default:"—" }}</td>
          <td class="px-3 py-2">{{ p.department|default:"—" }}</td>

          <td class="px-3 py-2">
            {% if p.employment_type == "COS" %}
              <span class="pill pill-cos">COS</span>
            {% elif p.employment_type == "JO" %}
              <span class="pill pill-jo">JO</span>
            {% else %}
              —
            {% endif %}
          </td>

          <td class="px-3 py-2">
            <span class="status-badge status-pending">PENDING</span>
          </td>

          <td class="px-3 py-2">{{ p.created_at|date:"Y-m-d H:i" }}</td>

          <td class="px-3 py-2 text-right space-x-2">
            <form method="post" action="{% url 'approve_user' p.id %}" class="inline">
              {% csrf_token %}
              <button class="px-3 py-1 rounded bg-green-600 text-white text-xs">
                Approve
              </button>
            </form>

            <form method="post"
                  action="{% url 'reject_user' p.id %}"
                  class="inline"
                  onsubmit="return confirm('Reject this account?');">
              {% csrf_token %}
              <button class="px-3 py-1 rounded bg-rose-600 text-white text-xs">
                Reject
              </button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center py-6 text-slate-400">
            No pending accounts
          </td>
        </tr>
        {% endfor %}

        <!-- APPROVED -->
        <tr class="bg-emerald-50/40">
          <td colspan="8" class="px-3 py-2 font-semibold text-emerald-700">
            Approved Employees
          </td>
        </tr>

        {% for p in approved_profiles %}
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2 font-medium">{{ p.user.username }}</td>
          <td class="px-3 py-2">{{ p.user.email|default:"—" }}</td>
          <td class="px-3 py-2">{{ p.branch|default:"—" }}</td>
          <td class="px-3 py-2">{{ p.department|default:"—" }}</td>

          <td class="px-3 py-2">
            {% if p.employment_type == "COS" %}
              <span class="pill pill-cos">COS</span>
            {% elif p.employment_type == "JO" %}
              <span class="pill pill-jo">JO</span>
            {% else %}
              —
            {% endif %}
          </td>

          <td class="px-3 py-2">
            <span class="status-badge status-approved">APPROVED</span>
          </td>

          <td class="px-3 py-2">{{ p.created_at|date:"Y-m-d H:i" }}</td>

          <td class="px-3 py-2 text-right text-xs text-slate-400">
            —
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center py-6 text-slate-400">
            No approved employees
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <!-- ===================================================== -->
  <!-- ✅ EMPLOYEE PROFILES (SAME PAGE) -->
  <!-- ===================================================== -->
  <div class="glass rounded-3xl p-6 space-y-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-extrabold">Employee Profiles</h2>
        <p class="text-sm text-slate-500">Add, update, and delete employee profiles</p>
      </div>
    </div>

    <!-- ✅ CREATE EMPLOYEE -->
    <form method="post" action="{% url 'admin_employees' %}" class="grid grid-cols-1 md:grid-cols-6 gap-3">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_employee">

      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">Username</label>
        <input name="username" class="w-full px-3 py-2 rounded-xl border" required>
      </div>

      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">Email</label>
        <input name="email" type="email" class="w-full px-3 py-2 rounded-xl border">
      </div>

      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">Password</label>
        <input name="password" type="password" class="w-full px-3 py-2 rounded-xl border" required>
      </div>

      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">Department</label>
        <input name="department" class="w-full px-3 py-2 rounded-xl border">
      </div>

      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">Job Type</label>
        <select name="employment_type" class="w-full px-3 py-2 rounded-xl border" required>
          <option value="COS">COS</option>
          <option value="JO">JO</option>
        </select>
      </div>

      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">Branch</label>
        {% if request.user.is_superuser %}
          <select name="branch_id" class="w-full px-3 py-2 rounded-xl border" required>
            <option value="">Select branch</option>
            {% for b in branches %}
              <option value="{{ b.id }}">{{ b.name }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input class="w-full px-3 py-2 rounded-xl border bg-slate-50"
                 value="{{ request.user.profile.branch }}"
                 disabled>
        {% endif %}
      </div>

      <div class="md:col-span-6 flex justify-end">
        <button class="px-4 py-2 rounded-xl bg-teal-600 text-white hover:bg-teal-700">
          Create Employee
        </button>
      </div>
    </form>

    <!-- ✅ PROFILES TABLE -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="text-xs uppercase text-slate-500 border-b">
          <tr>
            <th class="px-3 py-2 text-left">Username</th>
            <th class="px-3 py-2 text-left">Email</th>
            <th class="px-3 py-2 text-left">Branch</th>
            <th class="px-3 py-2 text-left">Department</th>
            <th class="px-3 py-2 text-left">Job Type</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-right">Actions</th>
          </tr>
        </thead>

        <tbody class="divide-y">
          {% for p in employee_profiles %}
          <tr class="hover:bg-slate-50">
            <form method="post" action="{% url 'admin_employees' %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_employee">
              <input type="hidden" name="profile_id" value="{{ p.id }}">

              <td class="px-3 py-2 font-medium">{{ p.user.username }}</td>

              <td class="px-3 py-2">
                <input name="email" value="{{ p.user.email }}" class="w-full px-2 py-1 rounded border">
              </td>

              <td class="px-3 py-2">
                {% if request.user.is_superuser %}
                  <select name="branch_id" class="w-full px-2 py-1 rounded border">
                    {% for b in branches %}
                      <option value="{{ b.id }}" {% if p.branch_id == b.id %}selected{% endif %}>
                        {{ b.name }}
                      </option>
                    {% endfor %}
                  </select>
                {% else %}
                  {{ p.branch|default:"—" }}
                {% endif %}
              </td>

              <td class="px-3 py-2">
                <input name="department" value="{{ p.department }}" class="w-full px-2 py-1 rounded border">
              </td>

              <td class="px-3 py-2">
                <select name="employment_type" class="w-full px-2 py-1 rounded border">
                  <option value="COS" {% if p.employment_type == "COS" %}selected{% endif %}>COS</option>
                  <option value="JO" {% if p.employment_type == "JO" %}selected{% endif %}>JO</option>
                </select>
              </td>

              <td class="px-3 py-2">
                {% if p.is_approved %}
                  <span class="status-badge status-approved">APPROVED</span>
                {% else %}
                  <span class="status-badge status-pending">PENDING</span>
                {% endif %}
              </td>

              <td class="px-3 py-2 text-right space-x-2">
                <button class="px-3 py-1 rounded bg-indigo-600 text-white text-xs">
                  Update
                </button>
            </form>

                <form method="post"
                      action="{% url 'admin_employees' %}"
                      class="inline"
                      onsubmit="return confirm('Delete this employee?');">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete_employee">
                  <input type="hidden" name="profile_id" value="{{ p.id }}">
                  <button class="px-3 py-1 rounded bg-rose-600 text-white text-xs">
                    Delete
                  </button>
                </form>
              </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-6 text-slate-400">
              No employee profiles found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
