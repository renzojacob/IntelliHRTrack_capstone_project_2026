{% extends 'admin/base_admin.html' %}

{% block title %}IntelliHRTrack ‚Äî Module 3: Employee Management{% endblock %}

{% block extra_head %}
<style>
    :root { --accent:#14b8a6; --accent-to:#0ea5a0; --card-bg:rgba(255,255,255,0.6); --card-border:rgba(255,255,255,0.35);
      --noise:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.035"/></svg>'); }
    html[data-accent="teal"] { --accent:#14b8a6; --accent-to:#0ea5a0; }
    html[data-accent="purple"] { --accent:#8b5cf6; --accent-to:#7c3aed; }
    html[data-accent="rose"] { --accent:#f43f5e; --accent-to:#e11d48; }
    html[data-accent="amber"] { --accent:#f59e0b; --accent-to:#d97706; }
    html[data-bg="gradient"] body::before { content:""; position:fixed; inset:0; z-index:-2; background:
      radial-gradient(800px 400px at 10% -10%, rgba(59,130,246,0.15), transparent 60%),
      radial-gradient(600px 300px at 120% 0%, rgba(20,184,166,0.18), transparent 60%),
      linear-gradient(120deg, rgba(2,6,23,0.03), rgba(2,6,23,0.06)); }
    html[data-bg="image"] body::before { content:""; position:fixed; inset:0; z-index:-2; background:url('https://images.unsplash.com/photo-1531297484001-80022131f5a1?auto=format&fit=crop&w=2100&q=60') center/cover no-repeat fixed; filter:saturate(1.05) brightness(0.95); }
    body::after { content:""; position:fixed; inset:0; pointer-events:none; z-index:-1; background-image:var(--noise); }

    .glass { background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--card-border); }
    .dark .glass { background: rgba(15,23,42,0.60); border-color: rgba(255,255,255,0.08); }
    .gradient-accent { background-image: linear-gradient(135deg, var(--accent), var(--accent-to)); }
    .text-accent { color: var(--accent); }
    .neon-divider { height:1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity:.6; }
    .fancy-scroll::-webkit-scrollbar { height:10px; width:10px; }
    .fancy-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent), var(--accent-to)); border-radius:9999px; }
    .fancy-scroll::-webkit-scrollbar-track { background: transparent; }
    .big-scroll { scrollbar-width:auto; scrollbar-color: var(--accent) transparent; }
    .big-scroll::-webkit-scrollbar { width:16px; height:16px; }
    .big-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent), var(--accent-to)); border-radius:12px; border:3px solid transparent; background-clip: content-box; }
    .ripple { position: relative; overflow: hidden; }
    .ripple::after { content:''; position:absolute; inset:0; background: radial-gradient(circle, rgba(255,255,255,0.3) 1%, transparent 1%) center/15000%; opacity:0; transition: opacity .5s; }
    .ripple:active::after { opacity:1; background-size:100%; transition:0s; }
    /* Sidebar resize via CSS var */
    :root { --sidebar: 18rem; }
    @media (min-width: 1024px){ aside[data-resizable]{ width: var(--sidebar) !important; } main[data-shift]{ margin-left: var(--sidebar) !important; } }
    /* Toasts + progress */
    #toastHost { position: fixed; top: 16px; right: 16px; display: grid; gap: 10px; z-index: 80; pointer-events: none; }
    .toast { pointer-events: auto; min-width: 220px; max-width: 360px; padding: 10px 12px; border-radius: 12px; box-shadow: 0 10px 20px rgba(2,6,23,.2); border: 1px solid rgba(255,255,255,.35); }
    .toast.info { background: var(--card-bg); }
    .toast.success { background: linear-gradient(135deg, rgba(16,185,129,.15), rgba(20,184,166,.25)); }
    .toast.warn { background: linear-gradient(135deg, rgba(245,158,11,.15), rgba(245,158,11,.28)); }
    .toast.error { background: linear-gradient(135deg, rgba(244,63,94,.15), rgba(244,63,94,.28)); }
    #topProgress { background-image: linear-gradient(90deg, var(--accent), var(--accent-to)); }
    /* Dark-mode form controls readability */
    select, input, textarea { color: #111827; }
    .dark select, .dark input, .dark textarea { background-color: rgba(255,255,255,0.08); color: #e5e7eb; border-color: rgba(255,255,255,0.15); }
    .dark select option { background-color: #0f172a; color: #e5e7eb; }
  </style>
{% endblock %}

{% block content %}
<!-- Hero -->
      <header id="section-top" class="relative overflow-hidden rounded-3xl glass p-6 md:p-8 shadow-glow">
        <div class="absolute inset-0 opacity-40 animate-shine" style="background-image: linear-gradient(90deg, var(--accent), rgba(255,255,255,0.2), var(--accent)); background-size: 200% 100%;"></div>
        <div class="relative z-10 flex items-center justify-between gap-4">
          <div>
            <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Employee Management ‚Äî Admin Console</h2>
            <p class="mt-1 text-sm md:text-base text-gray-600 dark:text-gray-300">Registry, search, profiles, biometrics, documents, analytics, and audit trail.</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="btnNew" class="px-4 py-2 rounded-xl text-white bg-gradient-to-r from-emerald-600 to-teal-600 hover:shadow-glow transition flex items-center justify-center gap-2 ripple"><iconify-icon icon="ph:user-plus-duotone"></iconify-icon> New Employee</button>
            <button id="downloadTemplate" class="px-3 py-2 rounded-xl bg-white/80 dark:bg-slate-900/50 border border-white/40 dark:border-white/10 hover:shadow-glow transition flex items-center justify-center gap-2 ripple"><iconify-icon icon="ph:file-csv-duotone" class="text-accent"></iconify-icon> CSV Template</button>
          </div>
        </div>
      </header>

      <!-- Stats Cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="glass rounded-2xl p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-xs text-slate-500 dark:text-slate-400">Total Employees</div>
              <div id="statTotal" class="text-2xl font-extrabold mt-1">0</div>
            </div>
            <div class="text-slate-400 text-lg">üë•</div>
          </div>
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-3">Includes active & archived records. Click charts for details.</p>
        </div>
        <div class="glass rounded-2xl p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-xs text-slate-500 dark:text-slate-400">Active Employees</div>
              <div id="statActive" class="text-2xl font-extrabold mt-1">0</div>
            </div>
            <div class="text-slate-400 text-lg">‚úÖ</div>
          </div>
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-3">Employees currently marked as Active.</p>
        </div>
        <div class="glass rounded-2xl p-4 shadow">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-xs text-slate-500 dark:text-slate-400">Departments</div>
              <div id="statDepts" class="text-2xl font-extrabold mt-1">0</div>
            </div>
            <div class="text-slate-400 text-lg">üè∑Ô∏è</div>
          </div>
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-3">Unique department count in the system</p>
        </div>
      </section>

      <!-- Main Grid -->
      <section class="grid grid-cols-12 gap-6">
        <!-- Left column -->
        <div class="col-span-12 xl:col-span-8 space-y-6">
          <!-- Controls -->
          <div class="glass rounded-2xl p-4 shadow">
            <div class="flex flex-col lg:flex-row gap-3 items-start lg:items-center justify-between">
              <div class="flex flex-wrap items-center gap-2 w-full lg:w-2/3">
                <input id="searchInput" class="min-w-0 flex-1 p-3 rounded-lg border bg-transparent focus:outline-none" placeholder="Search by name, ID, department, or position..." />
                <select id="filterStatus" class="min-w-[10rem] shrink-0 p-3 rounded-lg border bg-white/70 dark:bg-white/10 dark:border-white/10 text-sm text-gray-800 dark:text-gray-100">
                  <option value="all">All Statuses</option>
                  <option value="active">Active</option>
                  <option value="onleave">On Leave</option>
                  <option value="terminated">Terminated</option>
                </select>
                <select id="filterDept" class="min-w-[12rem] shrink-0 p-3 rounded-lg border bg-white/70 dark:bg-white/10 dark:border-white/10 text-sm text-gray-800 dark:text-gray-100">
                  <option value="all">All Departments</option>
                </select>
              </div>
              <div class="flex gap-2 w-full lg:w-auto justify-end">
                <button id="btnExportCsv" class="px-4 py-2 rounded-xl bg-white/80 dark:bg-slate-900/50 border border-white/40 dark:border-white/10 hover:shadow-glow transition ripple">Export CSV</button>
                <label for="fileImport" class="cursor-pointer px-4 py-2 rounded-xl text-white bg-indigo-600 hover:shadow-glow transition ripple">Import CSV</label>
                <input id="fileImport" type="file" accept=".csv" class="hidden" />
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="glass rounded-2xl p-4 shadow">
            <div class="overflow-auto fancy-scroll">
              <table class="min-w-full text-sm align-middle">
                <thead class="text-left text-slate-500 dark:text-slate-400">
                  <tr>
                    <th class="px-3 py-2">#</th>
                    <th class="px-3 py-2">Photo</th>
                    <th class="px-3 py-2">Name / ID</th>
                    <th class="px-3 py-2">Department</th>
                    <th class="px-3 py-2">Position</th>
                    <th class="px-3 py-2">Status</th>
                    <th class="px-3 py-2">Tenure</th>
                    <th class="px-3 py-2 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="employeeTable" class="divide-y"></tbody>
              </table>
            </div>
            <div class="mt-3 flex items-center justify-between">
              <div class="text-xs text-slate-500" id="tableInfo">Showing 0</div>
              <div class="flex gap-2">
                <button id="prevPage" class="px-3 py-1 rounded-xl bg-white/80 dark:bg-slate-900/50 border border-white/40 dark:border-white/10 ripple">Prev</button>
                <button id="nextPage" class="px-3 py-1 rounded-xl bg-white/80 dark:bg-slate-900/50 border border-white/40 dark:border-white/10 ripple">Next</button>
              </div>
            </div>
          </div>

          <!-- Audit Trail -->
          <div id="section-audit" class="glass rounded-2xl p-4 shadow">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold flex items-center gap-2"><iconify-icon icon="ph:warning-duotone" class="text-accent"></iconify-icon> Audit Trail & Recent Activity</h3>
              <div class="text-xs text-slate-500 dark:text-slate-400">Immutable logs of CRUD operations</div>
            </div>
            <div id="auditList" class="space-y-2 max-h-48 overflow-auto text-sm text-slate-700 dark:text-slate-200 fancy-scroll"></div>
          </div>

          <!-- Moved from right to balance layout -->
          <div class="glass rounded-2xl p-4 shadow">
            <h3 class="font-semibold mb-3">Quick Verification</h3>
            <div class="space-y-2">
              <input id="verifyInput" placeholder="Enter Employee ID to verify..." class="w-full p-2 rounded border bg-transparent" />
              <button id="btnVerify" class="w-full px-3 py-2 rounded-xl bg-blue-600 text-white ripple">Verify</button>
              <div id="verifyResult" class="mt-2 text-sm text-slate-700 dark:text-slate-200"></div>
            </div>
          </div>

          <div id="section-admin" class="glass rounded-2xl p-4 shadow">
            <h3 class="font-semibold mb-3">Upload &amp; Documents</h3>
            <input id="docUpload" type="file" class="w-full" />
            <p class="text-xs text-slate-500 mt-2">Upload documents and attach to selected employee in profile view.</p>
          </div>
        </div>

        <!-- Right column -->
        <div class="col-span-12 xl:col-span-4 space-y-6">
          <div id="section-stats" class="glass rounded-2xl p-4 shadow">
            <h3 class="font-semibold mb-3">Employee Statistics</h3>
            <canvas id="deptChart" height="200"></canvas>
          </div>
          <div class="glass rounded-2xl p-4 shadow">
            <h3 class="font-semibold mb-3">Growth &amp; Attrition</h3>
            <canvas id="growthChart" height="180"></canvas>
          </div>
        </div>
      </section>

      <footer class="pb-8 pt-2 text-xs text-gray-500 dark:text-gray-400 text-center">¬© IntelliHRTrack ‚Ä¢ Module 3 ‚Äî Demonstration build. All biometric and document actions are simulated.</footer>
{% endblock %}

{% block extra_js %}
<script>
    // ---------- THEME ----------
    const sidebarThemeToggle = document.getElementById('themeToggle');
    function setThemeMode(mode){
      if(mode==='dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
      // Persist using dashboard key for consistency + fallback to legacy key
      localStorage.setItem('ih_theme', mode);
      localStorage.setItem('iht_theme_v1', mode);
    }
    const savedTheme = localStorage.getItem('ih_theme') || localStorage.getItem('iht_theme_v1') || 'light';
    setThemeMode(savedTheme);
    sidebarThemeToggle?.addEventListener('click', ()=> setThemeMode(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));

    // ---------- TOASTS ----------
    const toastHost = document.getElementById('toastHost');
    function showToast(msg, type='info', duration=2200){
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="text-sm">${msg}</div>`;
      toastHost.appendChild(t);
      setTimeout(()=>{ t.style.opacity = '0'; t.style.transform = 'translateY(-6px)'; setTimeout(()=> t.remove(), 300); }, duration);
    }

    // ---------- TOP PROGRESS ----------
    const topProgress = document.getElementById('topProgress');
    function progressStart(){ topProgress.style.transition='none'; topProgress.style.width='0'; topProgress.style.opacity='1'; requestAnimationFrame(()=>{ topProgress.style.transition='width .8s ease'; topProgress.style.width='75%'; }); }
    function progressDone(){ topProgress.style.width='100%'; setTimeout(()=>{ topProgress.style.opacity='0'; topProgress.style.width='0'; }, 350); }

    // ---------- BACK TO TOP ----------
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', ()=>{ if(window.scrollY > 400) backToTop.classList.remove('hidden'); else backToTop.classList.add('hidden'); });
    backToTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

    // ---------- NAV SMOOTH SCROLL (desktop + mobile) ----------
    const asideLinks = Array.from(document.querySelectorAll('aside a[data-target]'));
    function wireSmooth(list){
      list.forEach(a=> a.addEventListener('click', (e)=>{
        e.preventDefault(); const sel = a.getAttribute('data-target'); const el = document.querySelector(sel);
        if(el){ window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 12, behavior:'smooth'}); closeMobile(); }
        asideLinks.forEach(n=> n.classList.remove('ring','ring-white/30'));
        a.classList.add('ring','ring-white/30');
      }));
    }
    wireSmooth(asideLinks);

    // ---------- MOBILE SIDEBAR ----------
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobilePanel = document.getElementById('mobilePanel');
    const mobileBackdrop = document.getElementById('mobileBackdrop');
    const closeMobileBtn = document.getElementById('closeMobile');
    const mobileFab = document.getElementById('mobileMenuFab');
    function openMobile(){
      const desk = document.querySelector('aside nav ul');
      const mobileNavContent = document.getElementById('mobileNavContent');
      if(desk && mobileNavContent){ mobileNavContent.innerHTML=''; mobileNavContent.appendChild(desk.cloneNode(true));
        mobileNavContent.querySelectorAll('a').forEach(a=>{
          a.addEventListener('click', (ev)=>{
            const tgt = a.getAttribute('data-target');
            if(tgt){ ev.preventDefault(); const el = document.querySelector(tgt); if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); } mobileNavContent.querySelectorAll('a').forEach(n=> n.classList.remove('ring','ring-white/30')); a.classList.add('ring','ring-white/30'); }
            closeMobile();
          });
        });
      }
      mobileSidebar.classList.remove('hidden');
      setTimeout(()=> mobilePanel.classList.remove('-translate-x-full'), 10);
    }
    function closeMobile(){ mobilePanel.classList.add('-translate-x-full'); setTimeout(()=> mobileSidebar.classList.add('hidden'), 250); }
    mobileFab?.addEventListener('click', openMobile);
    mobileBackdrop?.addEventListener('click', closeMobile);
    closeMobileBtn?.addEventListener('click', closeMobile);

    // ---------- SETTINGS & SHORTCUTS ----------
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettings = document.getElementById('closeSettings');
    function openSettings(){ settingsPanel.classList.remove('hidden'); settingsPanel.classList.add('flex'); }
    function closeSettingsFn(){ settingsPanel.classList.add('hidden'); settingsPanel.classList.remove('flex'); }
    document.getElementById('customizeLayout')?.addEventListener('click', openSettings);
    closeSettings?.addEventListener('click', closeSettingsFn);
    settingsPanel?.addEventListener('click', (e)=>{ if(e.target===settingsPanel) closeSettingsFn(); });

    const shortcutsModal = document.getElementById('shortcutsModal');
    const closeShortcuts = document.getElementById('closeShortcuts');
    function openShortcuts(){ shortcutsModal.classList.remove('hidden'); shortcutsModal.classList.add('flex'); }
    function closeShortcutsFn(){ shortcutsModal.classList.add('hidden'); shortcutsModal.classList.remove('flex'); }
    document.getElementById('shortcutsBtn')?.addEventListener('click', openShortcuts);
    closeShortcuts?.addEventListener('click', closeShortcutsFn);
    shortcutsModal?.addEventListener('click', (e)=>{ if(e.target===shortcutsModal) closeShortcutsFn(); });

    const accentBtns = Array.from(document.querySelectorAll('#settingsPanel [data-accent]'));
    const bgBtns = Array.from(document.querySelectorAll('#settingsPanel [data-bg]'));
    const densityBtns = Array.from(document.querySelectorAll('#settingsPanel [data-density]'));
    const glassIntensity = document.getElementById('glassIntensity');
    const motionToggle = document.getElementById('motionToggle');
    const contrastToggle = document.getElementById('contrastToggle');
    const sidebarBtns = Array.from(document.querySelectorAll('#settingsPanel [data-sidebar]'));
    const fontBtns = Array.from(document.querySelectorAll('#settingsPanel [data-font]'));
    const saveSettings = document.getElementById('saveSettings');
    const resetSettings = document.getElementById('resetSettings');
    const exportPrefs = document.getElementById('exportPrefs');
    const importPrefsBtn = document.getElementById('importPrefsBtn');
    const prefsFile = document.getElementById('prefsFile');

    function getPrefs(){ try{ return JSON.parse(localStorage.getItem('ih_prefs')) || {}; }catch{ return {}; } }
    function setPrefs(p){ localStorage.setItem('ih_prefs', JSON.stringify(p)); }
    function applyPrefs(p){ if(p.accent) document.documentElement.setAttribute('data-accent', p.accent); if(p.bg) document.documentElement.setAttribute('data-bg', p.bg); document.documentElement.setAttribute('data-density', p.density||'comfortable'); document.documentElement.classList.toggle('reduce-motion', !!p.reduceMotion); if(motionToggle) motionToggle.checked = !!p.reduceMotion; }
    function applyGlass(val){ const alpha = parseFloat(val||'0.6'); document.documentElement.style.setProperty('--card-bg', `rgba(255,255,255,${alpha})`); document.documentElement.style.setProperty('--card-border', `rgba(255,255,255,${Math.max(0, Math.min(1, alpha*0.6))})`); }
    function applySidebar(size){ const map = { narrow:'14rem', default:'18rem', wide:'22rem' }; const px = map[size] || map.default; document.documentElement.style.setProperty('--sidebar', px); }
    function applyFont(f){ const size = f==='small'? '0.95rem' : f==='large'? '1.05rem' : '1rem'; document.documentElement.setAttribute('data-font', f||'base'); document.body.style.fontSize = size; }
    function applyPrefsExtended(p){ if(p.glass) applyGlass(p.glass); if(p.sidebar) applySidebar(p.sidebar); if(p.contrast!==undefined) document.documentElement.classList.toggle('high-contrast', !!p.contrast); if(p.font) applyFont(p.font); if(glassIntensity) glassIntensity.value = p.glass || '0.6'; if(contrastToggle) contrastToggle.checked = !!p.contrast; }
    const initPrefs = getPrefs(); applyPrefs(initPrefs); applyPrefsExtended(initPrefs);
    accentBtns.forEach(b=> b.addEventListener('click', ()=> document.documentElement.setAttribute('data-accent', b.dataset.accent)));
    bgBtns.forEach(b=> b.addEventListener('click', ()=> document.documentElement.setAttribute('data-bg', b.dataset.bg)));
    densityBtns.forEach(b=> b.addEventListener('click', ()=> document.documentElement.setAttribute('data-density', b.dataset.density)));
    sidebarBtns.forEach(b=> b.addEventListener('click', ()=> applySidebar(b.dataset.sidebar)));
    fontBtns.forEach(b=> b.addEventListener('click', ()=> applyFont(b.dataset.font)));
    glassIntensity?.addEventListener('input', ()=> applyGlass(glassIntensity.value));
    contrastToggle?.addEventListener('change', ()=> document.documentElement.classList.toggle('high-contrast', contrastToggle.checked));
    saveSettings?.addEventListener('click', ()=>{ const prev = getPrefs(); const p = { accent: document.documentElement.getAttribute('data-accent'), bg: document.documentElement.getAttribute('data-bg'), density: document.documentElement.getAttribute('data-density'), reduceMotion: motionToggle?.checked, glass: glassIntensity ? glassIntensity.value : (prev.glass||'0.6'), sidebar: prev.sidebar || 'default', contrast: contrastToggle ? contrastToggle.checked : !!prev.contrast, font: document.documentElement.getAttribute('data-font') || prev.font || 'base' }; setPrefs(p); applyPrefs(p); applyPrefsExtended(p); closeSettingsFn(); showToast('Preferences saved','success'); });
    resetSettings?.addEventListener('click', ()=>{ const p = {accent:'teal', bg:'gradient', density:'comfortable', reduceMotion:false, glass:'0.6', sidebar:'default', contrast:false, font:'base'}; setPrefs(p); applyPrefs(p); applyPrefsExtended(p); showToast('Preferences reset','info'); });
    exportPrefs?.addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(getPrefs(),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ih_prefs.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });
    importPrefsBtn?.addEventListener('click', ()=> prefsFile && prefsFile.click());
    prefsFile?.addEventListener('change', async ()=>{ const file=prefsFile.files&&prefsFile.files[0]; if(!file) return; try{ const txt=await file.text(); const json=JSON.parse(txt); setPrefs(json); applyPrefs(json); applyPrefsExtended(json); showToast('Preferences imported','success'); }catch{ showToast('Invalid preferences file','error'); } });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      if(e.key.toLowerCase()==='s'){ e.preventDefault(); openSettings(); }
      if(e.key.toLowerCase()==='t'){ e.preventDefault(); sidebarThemeToggle?.click(); }
      if(e.key==='?'){ e.preventDefault(); openShortcuts(); }
      if(e.key.toLowerCase()==='n'){ e.preventDefault(); document.getElementById('btnNew')?.click(); }
    });

    // ---------- EMPLOYEE APP (ported, features preserved) ----------
    const uid = () => 'E' + Date.now().toString(36).toUpperCase().slice(-6);
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const STORAGE_KEY = 'iht_employees_v1';
    const AUDIT_KEY = 'iht_audit_v1';

    function defaultData() {
      return [
        { id: 'E1001', first: 'Maria', last: 'Santos', email: 'maria.santos@doa.gov.ph', contact: '09171234567', department: 'Agronomy', position: 'Field Officer', etype: 'permanent', status: 'active', hired: '2019-03-12', photo: '', remarks: 'Senior field officer', docs: [], biometric: { face: true, finger: true }, history: [{ts: Date.now(), action: 'Hired (system init)'}] },
        { id: 'E1002', first: 'Jose', last: 'Reyes', email: 'jose.reyes@doa.gov.ph', contact: '09171239876', department: 'Irrigation', position: 'Technician', etype: 'contractual', status: 'active', hired: '2022-06-01', photo: '', remarks: '', docs: [], biometric: { face: false, finger: false }, history: [{ts: Date.now(), action: 'Hired (system init)'}] }
      ];
    }
    function saveData(employees) { localStorage.setItem(STORAGE_KEY, JSON.stringify(employees)); }
    function loadData() { let raw = localStorage.getItem(STORAGE_KEY); if (!raw) { const data = defaultData(); saveData(data); return data; } try { return JSON.parse(raw); } catch(e){ const data = defaultData(); saveData(data); return data;} }
    function addAudit(action, details='') { const raw = JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]'); raw.unshift({ ts: Date.now(), action, details }); localStorage.setItem(AUDIT_KEY, JSON.stringify(raw.slice(0,200))); renderAudit(); }

    let employees = loadData();
    let currentPage = 1;
    const PAGE_SIZE = 8;

    // DOM refs
    const tbl = $('#employeeTable');
    const statTotal = $('#statTotal');
    const statActive = $('#statActive');
    const statDepts = $('#statDepts');
    const filterDept = $('#filterDept');
    const searchInput = $('#searchInput');
    const filterStatus = $('#filterStatus');
    const prevPage = $('#prevPage');
    const nextPage = $('#nextPage');
    const tableInfo = $('#tableInfo');

    // Charts
    let deptChart, growthChart;
    function renderCharts() {
      const depts = {}; const growth = {};
      employees.forEach(e => { depts[e.department] = (depts[e.department] || 0) + 1; const y = (new Date(e.hired)).getFullYear(); if(!isNaN(y)) growth[y] = (growth[y] || 0) + 1; });
      const labels = Object.keys(depts).length ? Object.keys(depts) : ['None'];
      const values = Object.keys(depts).length ? Object.values(depts) : [0];
      const ctx = document.getElementById('deptChart').getContext('2d');
      if (deptChart) deptChart.destroy();
      deptChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: ['#10B981','#06B6D4','#6366F1','#F59E0B','#EF4444','#8B5CF6'] }] }, options: { responsive:true, plugins:{legend:{position:'bottom'}}, onClick(e, elements){ if(elements[0]) { const idx = elements[0].index; filterDept.value = labels[idx]; renderTable(); } } } });
      const gy = Object.keys(growth).sort(); const gv = gy.map(k=>growth[k]);
      const ctx2 = document.getElementById('growthChart').getContext('2d');
      if (growthChart) growthChart.destroy();
      growthChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: gy,
          datasets: [
            { label: 'New Hires', data: gv, backgroundColor: '#60a5fa' }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: 'rgba(148,163,184,0.25)' } }
          }
        }
      });
    }

    function uniqueDepartments() { const s = new Set(employees.map(e=>e.department).filter(Boolean)); return Array.from(s).sort(); }
    function renderFilters() {
      const depts = uniqueDepartments();
      filterDept.innerHTML = '<option value="all">All Departments</option>';
      depts.forEach(d=>{ const opt = document.createElement('option'); opt.value = d; opt.textContent = d; filterDept.appendChild(opt); });
      const dl = $('#deptList'); if(dl){ dl.innerHTML=''; depts.forEach(d=>{ const o=document.createElement('option'); o.value=d; dl.appendChild(o); }); }
      const posSet = new Set(employees.map(e=>e.position).filter(Boolean));
      const pl = $('#posList'); if(pl){ pl.innerHTML=''; Array.from(posSet).forEach(p=>{ const o=document.createElement('option'); o.value=p; pl.appendChild(o); }); }
      statDepts.textContent = depts.length;
    }
    function computeTenure(hired) { if(!hired) return '--'; const start = new Date(hired); if(isNaN(start)) return '--'; const now = new Date(); let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); if (months < 0) { years -=1; months += 12; } return `${years}y ${months}m`; }
    function renderStatus(s){ if (s==='active') return `<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Active</span>`; if (s==='onleave') return `<span class="px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800">On Leave</span>`; if (s==='terminated') return `<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800">Terminated</span>`; return s; }

    function renderTable() {
      renderFilters();
      const q = searchInput.value.trim().toLowerCase();
      const status = filterStatus.value; const dept = filterDept.value;
      let filtered = employees.filter(e=> { if (status !== 'all' && e.status !== status) return false; if (dept !== 'all' && e.department !== dept) return false; if (!q) return true; const s = `${e.id} ${e.first} ${e.last} ${e.department} ${e.position} ${e.email}`.toLowerCase(); return s.includes(q); });
      const total = filtered.length; const pages = Math.max(1, Math.ceil(total / PAGE_SIZE)); if (currentPage > pages) currentPage = pages; const start = (currentPage-1) * PAGE_SIZE; const pageSlice = filtered.slice(start, start+PAGE_SIZE);
      tbl.innerHTML = '';
      pageSlice.forEach((e, idx) => {
        const tr = document.createElement('tr'); tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-800';
        const avatar = e.photo || ('https://ui-avatars.com/api/?name=' + encodeURIComponent((e.first||'') + ' ' + (e.last||'')));
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${start + idx + 1}</td>
          <td class="px-3 py-2"><div class="w-10 h-10 rounded overflow-hidden bg-slate-100"><img src="${avatar}" class="w-full h-full object-cover"/></div></td>
          <td class="px-3 py-2"><div class="font-medium">${e.first||''} ${e.last||''}</div><div class="text-xs text-slate-500">${e.id||''}</div></td>
          <td class="px-3 py-2">${e.department || '‚Äî'}</td>
          <td class="px-3 py-2">${e.position || '‚Äî'}</td>
          <td class="px-3 py-2">${renderStatus(e.status)}</td>
          <td class="px-3 py-2">${computeTenure(e.hired)}</td>
          <td class="px-3 py-2 text-right">
            <div class="inline-flex gap-2">
              <button class="viewBtn px-3 py-1 rounded-xl bg-white/80 dark:bg-slate-900/50 border border-white/40 dark:border-white/10 ripple" data-id="${e.id}">View</button>
              <button class="editBtn px-3 py-1 rounded-xl bg-white/80 dark:bg-slate-900/50 border border-white/40 dark:border-white/10 ripple" data-id="${e.id}">Edit</button>
            </div>
          </td>`;
        tbl.appendChild(tr);
      });
      tableInfo.textContent = `Showing ${total? (start+1) : 0} - ${Math.min(total, start+PAGE_SIZE)} of ${total}`;
      statTotal.textContent = employees.length;
      statActive.textContent = employees.filter(x=>x.status==='active').length;
      renderCharts();
      attachRowEvents();
    }

    function attachRowEvents(){
      $$('.viewBtn').forEach(b=> b.onclick = e => openProfile(b.dataset.id));
      $$('.editBtn').forEach(b=> b.onclick = e => openEdit(b.dataset.id));
    }

    function renderAudit(){
      const list = JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]');
      const container = $('#auditList'); container.innerHTML = '';
      list.slice(0,30).forEach(item=>{ const d = new Date(item.ts).toLocaleString(); const div = document.createElement('div'); div.className = 'text-xs'; div.innerHTML = `<div class="font-medium">${item.action}</div><div class="text-slate-500">${item.details}</div><div class="text-slate-400 text-xs">${d}</div>`; container.appendChild(div); });
    }

    // Profile modal
    const profileModal = $('#profileModal');
    let currentProfileId = null;
    function openProfile(id){ const e = employees.find(x=>x.id===id); if(!e) return; currentProfileId = id; $('#profileAvatarImg').src = e.photo || ('https://ui-avatars.com/api/?name=' + encodeURIComponent((e.first||'') + ' ' + (e.last||''))); $('#profileName').textContent = `${e.first||''} ${e.last||''}`; $('#profileId').textContent = `ID: ${e.id}`; $('#profileContact').textContent = `${e.contact||''} ¬∑ ${e.email || '‚Äî'}`; $('#profileDept').textContent = e.department || '‚Äî'; $('#profilePos').textContent = e.position || '‚Äî'; $('#profileHired').textContent = e.hired || '‚Äî'; const ps = $('#profileStatus'); ps.textContent=''; ps.className='mt-1 inline-block px-2 py-1 rounded text-sm'; if (e.status==='active') { ps.textContent='Active'; ps.classList.add('bg-green-100','text-green-800'); } if (e.status==='onleave') { ps.textContent='On Leave'; ps.classList.add('bg-yellow-100','text-yellow-800'); } if (e.status==='terminated') { ps.textContent='Terminated'; ps.classList.add('bg-red-100','text-red-800'); }
      $('#faceEnroll').textContent = e.biometric?.face ? 'Enrolled' : 'Not enrolled';
      $('#fingerEnroll').textContent = e.biometric?.finger ? 'Enrolled' : 'Not enrolled';
      const docs = $('#profileDocs'); docs.innerHTML = ''; (e.docs||[]).forEach((d) => { const div = document.createElement('div'); div.className='flex items-center justify-between gap-2'; div.innerHTML = `<div>${d.name}</div><div class="text-xs text-slate-500">${(new Date(d.ts)).toLocaleDateString()}</div>`; docs.appendChild(div); });
      const hist = $('#profileHistory'); hist.innerHTML = ''; (e.history||[]).slice().reverse().forEach(h=>{ const node = document.createElement('div'); node.className='text-xs text-slate-500'; node.innerHTML = `<div>${h.action}</div><div class="text-xs text-slate-400">${new Date(h.ts).toLocaleString()}</div>`; hist.appendChild(node); });
      profileModal.classList.remove('hidden'); profileModal.classList.add('flex');
    }
    $('#btnCloseProfile').addEventListener('click', ()=> { profileModal.classList.add('hidden'); profileModal.classList.remove('flex'); });
    $('#btnPrintProfile').addEventListener('click', () => { const e = employees.find(x=>x.id===currentProfileId); if(!e) return; const w = window.open('', '_blank'); w.document.write(`<pre>${JSON.stringify(e, null, 2)}</pre>`); w.print(); });
    $('#enrollFace').addEventListener('click', () => { if(!currentProfileId) return; const e = employees.find(x=>x.id===currentProfileId); e.biometric = e.biometric || {}; e.biometric.face = true; e.history.push({ts: Date.now(), action: 'Face enrolled (simulated)'}); saveData(employees); addAudit('Enroll Face', e.id); renderTable(); openProfile(currentProfileId); });
    $('#removeFace').addEventListener('click', () => { if(!currentProfileId) return; const e = employees.find(x=>x.id===currentProfileId); e.biometric = e.biometric || {}; e.biometric.face = false; e.history.push({ts: Date.now(), action: 'Face removed (simulated)'}); saveData(employees); addAudit('Remove Face', e.id); renderTable(); openProfile(currentProfileId); });
    $('#enrollFinger').addEventListener('click', () => { if(!currentProfileId) return; const e = employees.find(x=>x.id===currentProfileId); e.biometric = e.biometric || {}; e.biometric.finger = true; e.history.push({ts: Date.now(), action: 'Fingerprint enrolled (simulated)'}); saveData(employees); addAudit('Enroll Fingerprint', e.id); renderTable(); openProfile(currentProfileId); });
    $('#removeFinger').addEventListener('click', () => { if(!currentProfileId) return; const e = employees.find(x=>x.id===currentProfileId); e.biometric = e.biometric || {}; e.biometric.finger = false; e.history.push({ts: Date.now(), action: 'Fingerprint removed (simulated)'}); saveData(employees); addAudit('Remove Fingerprint', e.id); renderTable(); openProfile(currentProfileId); });
    $('#btnArchiveEmployee').addEventListener('click', ()=> { if(!currentProfileId) return; const e = employees.find(x=>x.id===currentProfileId); e.status = 'terminated'; e.history.push({ts: Date.now(), action: 'Archived/Terminated by admin'}); saveData(employees); addAudit('Archive Employee', e.id); renderTable(); openProfile(currentProfileId); });

    // New/Edit
    const editModal = $('#editModal');
    $('#btnNew').addEventListener('click', ()=> openEdit());
    $('#btnCancelEdit').addEventListener('click', ()=> { editModal.classList.add('hidden'); editModal.classList.remove('flex'); });
    function openEdit(id){ editModal.classList.add('flex'); editModal.classList.remove('hidden'); document.getElementById('employeeForm').reset(); $('#empId').value = ''; $('#editTitle').textContent = 'New Employee'; if (id) { const e = employees.find(x=>x.id===id); $('#editTitle').textContent = 'Edit Employee'; $('#empId').value = e.id; $('#firstName').value = e.first||''; $('#lastName').value = e.last||''; $('#email').value = e.email||''; $('#contact').value = e.contact||''; $('#department').value = e.department||''; $('#position').value = e.position||''; $('#etype').value = e.etype||'permanent'; $('#status').value = e.status||'active'; $('#hired').value = e.hired||''; $('#remarks').value = e.remarks||''; } }
    $('#employeeForm').addEventListener('submit', e => { e.preventDefault(); const id = $('#empId').value || uid(); const emp = { id, first: $('#firstName').value.trim(), last: $('#lastName').value.trim(), email: $('#email').value.trim(), contact: $('#contact').value.trim(), department: $('#department').value.trim(), position: $('#position').value.trim(), etype: $('#etype').value, status: $('#status').value, hired: $('#hired').value, photo: '', remarks: $('#remarks').value.trim(), docs: [], biometric: { face: false, finger: false }, history: [] }; const f = document.getElementById('photoUpload').files?.[0]; if (f) { const reader = new FileReader(); reader.onload = ev => { emp.photo = ev.target.result; finalizeSave(emp, id); }; reader.readAsDataURL(f); } else { finalizeSave(emp, id); } });
    function finalizeSave(emp, id) { const existing = employees.find(x=>x.id===id); if (existing) { Object.assign(existing, emp); existing.history = existing.history || []; existing.history.push({ts: Date.now(), action: 'Updated profile'}); addAudit('Update Employee', existing.id); } else { emp.id = id; emp.history = emp.history || []; emp.history.push({ts: Date.now(), action: 'Created profile'}); employees.unshift(emp); addAudit('Create Employee', emp.id); } saveData(employees); editModal.classList.add('hidden'); editModal.classList.remove('flex'); renderTable(); showToast('Employee saved','success'); }

    // Photo in profile
    $('#btnChangePhoto').addEventListener('click', () => { $('#avatarInput').click(); });
    $('#avatarInput').addEventListener('change', e => { const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev => { const eobj = employees.find(x=>x.id===currentProfileId); eobj.photo = ev.target.result; eobj.history.push({ts: Date.now(), action: 'Photo updated'}); saveData(employees); addAudit('Photo updated', eobj.id); renderTable(); openProfile(currentProfileId); }; reader.readAsDataURL(f); });
    $('#btnRemovePhoto').addEventListener('click', () => { const eobj = employees.find(x=>x.id===currentProfileId); if(!eobj) return; eobj.photo = ''; eobj.history.push({ts: Date.now(), action: 'Photo removed'}); saveData(employees); addAudit('Photo removed', eobj.id); renderTable(); openProfile(currentProfileId); });

    // Import / Export
    document.getElementById('downloadTemplate').addEventListener('click', () => { const csv = 'id,first,last,email,contact,department,position,etype,status,hired,remarks\nE000X,Juan,DelaCruz,juan@example.com,0917xxx,Agronomy,Officer,permanent,active,2023-01-01,notes\n'; const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'employee_template.csv'; a.click(); URL.revokeObjectURL(url); });
    document.getElementById('fileImport').addEventListener('change', (ev) => { const f = ev.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = e => { const text = e.target.result; importCSV(text); ev.target.value = ''; }; reader.readAsText(f); });
    function importCSV(text) { const lines = text.split(/\r?\n/).filter(Boolean); if(lines.length < 2) { showToast('No rows found','warn'); return; } const headers = lines[0].split(',').map(h=>h.trim()); const imported = []; for (let i=1;i<lines.length;i++){ const cols = lines[i].split(','); const obj = {}; headers.forEach((h, idx)=> obj[h] = (cols[idx] || '').trim()); obj.id = obj.id || uid(); obj.photo=''; obj.docs=[]; obj.biometric={face:false,finger:false}; obj.history=[{ts:Date.now(), action:'Imported via CSV'}]; employees.push(obj); imported.push(obj); } saveData(employees); addAudit('Import CSV', `${imported.length} records`); renderTable(); showToast(`Imported ${imported.length} records`,'success'); }
    document.getElementById('btnExportCsv').addEventListener('click', () => { const rows = [['id','first','last','email','contact','department','position','etype','status','hired','remarks']]; employees.forEach(e=> rows.push([e.id,e.first,e.last,e.email,e.contact,e.department,e.position,e.etype,e.status,e.hired,e.remarks])); const csv = rows.map(r=> r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n'); const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'employees_export.csv'; a.click(); URL.revokeObjectURL(url); addAudit('Export CSV'); showToast('Exported CSV','success'); });

    // Verification & Docs
    document.getElementById('btnVerify').addEventListener('click', ()=> { const q = document.getElementById('verifyInput').value.trim(); if (!q) { document.getElementById('verifyResult').textContent = 'Enter an employee ID.'; return; } const e = employees.find(x=> x.id === q || (`${x.first} ${x.last}`).toLowerCase() === q.toLowerCase()); if (!e) { document.getElementById('verifyResult').innerHTML = `<span class="text-rose-500">Not found</span>`; return; } document.getElementById('verifyResult').innerHTML = `<div class="font-medium">${e.first} ${e.last}</div><div class="text-xs text-slate-500">${e.position} ¬∑ ${e.department}</div>`; });
    document.getElementById('docUpload').addEventListener('change', e => { const f = e.target.files[0]; if(!f || !currentProfileId) { showToast('Open a profile first to attach','warn'); return; } const reader = new FileReader(); reader.onload = ev => { const bin = ev.target.result; const eobj = employees.find(x=>x.id===currentProfileId); eobj.docs.push({ name: f.name, data: bin, ts: Date.now() }); eobj.history.push({ts: Date.now(), action: `Document uploaded: ${f.name}`}); saveData(employees); addAudit('Upload Document', `${eobj.id} / ${f.name}`); openProfile(currentProfileId); }; reader.readAsDataURL(f); });

    // Pagination & filters
    prevPage.addEventListener('click', ()=> { if (currentPage>1) currentPage--; renderTable();});
    nextPage.addEventListener('click', ()=> { currentPage++; renderTable();});
    searchInput.addEventListener('input', ()=> { currentPage=1; renderTable(); });
    filterStatus.addEventListener('change', ()=> { currentPage=1; renderTable(); });
    filterDept.addEventListener('change', ()=> { currentPage=1; renderTable(); });

    // Initial render
    function initialRender(){ renderTable(); renderAudit(); setTimeout(()=> showToast('Employee Management ready','success'), 500); }
    initialRender();
  </script>
<script>
    // Sidebar active link highlighter (matches current filename)
    (function(){
      try{
        const current = location.pathname.split('/').pop();
        const links = document.querySelectorAll('aside nav a[href]');
        links.forEach(a=>{
          const href = a.getAttribute('href') || '';
          const name = href.split('/').pop();
          if(!name) return;
          if(name === current){
            a.classList.add('ring','ring-white/30','bg-accent/10');
            a.setAttribute('aria-current','page');
          }
        });
      }catch(e){ /* silent */ }
    })();
  </script>
{% endblock %}
