{% extends 'admin/base_admin.html' %}

{% block title %}intellihrtrack — module 3: employee management{% endblock %}

{% block extra_head %}
<style>
  :root { --accent: #14b8a6; --accent-to: #0ea5a0; --card-bg: rgba(255, 255, 255, 0.6); --card-border: rgba(255, 255, 255, 0.35); --sidebar: 18rem; --noise: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.035"/></svg>'); }
  html[data-accent="teal"] { --accent: #14b8a6; --accent-to: #0ea5a0; }
  html[data-accent="purple"] { --accent: #8b5cf6; --accent-to: #7c3aed; }
  html[data-accent="rose"] { --accent: #f43f5e; --accent-to: #e11d48; }
  html[data-accent="amber"] { --accent: #f59e0b; --accent-to: #d97706; }

  html[data-bg="gradient"] body::before {
    content: ""; position: fixed; inset: 0; z-index: -2;
    background:
      radial-gradient(800px 400px at 10% -10%, rgba(59, 130, 246, 0.15), transparent 60%),
      radial-gradient(600px 300px at 120% 0%, rgba(20, 184, 166, 0.18), transparent 60%),
      linear-gradient(120deg, rgba(2, 6, 23, 0.03), rgba(2, 6, 23, 0.06));
  }
  html[data-bg="image"] body::before {
    content: ""; position: fixed; inset: 0; z-index: -2;
    background: url('https://images.unsplash.com/photo-1531297484001-80022131f5a1?auto=format&fit=crop&w=2100&q=60') center/cover no-repeat fixed;
    filter: saturate(1.05) brightness(0.95);
  }
  body::after { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -1; background-image: var(--noise); }

  .glass { background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--card-border); }
  .dark .glass { background: rgba(15, 23, 42, 0.60); border-color: rgba(255, 255, 255, 0.08); }

  .gradient-accent { background-image: linear-gradient(135deg, var(--accent), var(--accent-to)); }
  .text-accent { color: var(--accent); }
  .fancy-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
  .fancy-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent), var(--accent-to)); border-radius: 9999px; }
  .fancy-scroll::-webkit-scrollbar-track { background: transparent; }

  .ripple { position: relative; overflow: hidden; }
  .ripple::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 1%, transparent 1%) center/15000%; opacity: 0; transition: opacity .5s; }
  .ripple:active::after { opacity: 1; background-size: 100%; transition: 0s; }

  #toastHost { position: fixed; top: 16px; right: 16px; display: grid; gap: 10px; z-index: 80; pointer-events: none; }
  .toast { pointer-events: auto; min-width: 220px; max-width: 360px; padding: 10px 12px; border-radius: 12px; box-shadow: 0 10px 20px rgba(2, 6, 23, .2); border: 1px solid rgba(255, 255, 255, .35); }
  .toast.info { background: var(--card-bg); }
  .toast.success { background: linear-gradient(135deg, rgba(16, 185, 129, .15), rgba(20, 184, 166, .25)); }
  .toast.warn { background: linear-gradient(135deg, rgba(245, 158, 11, .15), rgba(245, 158, 11, .28)); }
  .toast.error { background: linear-gradient(135deg, rgba(244, 63, 94, .15), rgba(244, 63, 94, .28)); }

  #topProgress { background-image: linear-gradient(90deg, var(--accent), var(--accent-to)); }

  select, input, textarea { color: #111827; }
  .dark select, .dark input, .dark textarea { background-color: rgba(255, 255, 255, 0.08); color: #e5e7eb; border-color: rgba(255, 255, 255, 0.15); }
  .dark select option { background-color: #0f172a; color: #e5e7eb; }

  .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
  .status-active { background-color: rgba(34, 197, 94, 0.1); color: rgb(22, 163, 74); }
  .status-onleave { background-color: rgba(245, 158, 11, 0.1); color: rgb(202, 138, 4); }
  .status-terminated { background-color: rgba(239, 68, 68, 0.1); color: rgb(220, 38, 38); }

  /* small helper for action buttons */
  .btn { padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.4rem; }
  .btn-approve { background: rgb(5 150 105); color: white; }
  .btn-approve:hover { opacity: .92; }
  .btn-reject { background: rgb(225 29 72); color: white; }
  .btn-reject:hover { opacity: .92; }
</style>
{% endblock %}

{% block content %}

{# django messages -> toast host #}
<div id="toastHost" aria-live="polite"></div>
<div id="topProgress" class="fixed top-0 left-0 h-1 w-0 z-[60] opacity-0 transition-all duration-300"></div>

<div class="min-h-screen p-4 md:p-6 lg:p-8 space-y-6">

  <!-- hero -->
  <header class="relative overflow-hidden rounded-3xl glass p-6 md:p-8 shadow-glow">
    <div class="absolute inset-0 opacity-40" style="background-image: linear-gradient(90deg, var(--accent), rgba(255,255,255,0.2), var(--accent)); background-size: 200% 100%;"></div>
    <div class="relative z-10 flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-gray-900 dark:text-white">employee management</h1>
        <p class="mt-1 text-sm md:text-base text-gray-600 dark:text-gray-300">
          approve employee accounts per branch and view approved users
        </p>
      </div>

      <div class="flex items-center gap-3 mt-4 lg:mt-0">
        <a href="{% url 'signup_ui' %}" class="px-4 py-2 rounded-xl text-white gradient-accent hover:opacity-95 transition flex items-center justify-center gap-2 ripple">
          <iconify-icon icon="ph:user-plus-duotone"></iconify-icon>
          signup page
        </a>
      </div>
    </div>
  </header>

  {# counts (server-side) #}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

    <div class="glass rounded-2xl p-5 shadow">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-400">total users</div>
          <div class="text-2xl font-extrabold mt-1">
            {{ pending_profiles|length|add:approved_profiles|length }}
          </div>
        </div>
        <iconify-icon icon="ph:users-duotone" class="text-2xl text-accent"></iconify-icon>
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">pending + approved</div>
    </div>

    <div class="glass rounded-2xl p-5 shadow">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-400">pending</div>
          <div class="text-2xl font-extrabold mt-1">{{ pending_profiles|length }}</div>
        </div>
        <iconify-icon icon="ph:hourglass-duotone" class="text-2xl text-amber-500"></iconify-icon>
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">waiting for approval</div>
    </div>

    <div class="glass rounded-2xl p-5 shadow">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-400">approved</div>
          <div class="text-2xl font-extrabold mt-1">{{ approved_profiles|length }}</div>
        </div>
        <iconify-icon icon="ph:check-circle-duotone" class="text-2xl text-green-500"></iconify-icon>
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">can login</div>
    </div>

    <div class="glass rounded-2xl p-5 shadow">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-sm text-slate-500 dark:text-slate-400">your branch</div>
          <div class="text-2xl font-extrabold mt-1">
            {% if request.user.is_superuser %}
              all
            {% else %}
              {% if request.user.profile.branch %}{{ request.user.profile.branch }}{% else %}—{% endif %}
            {% endif %}
          </div>
        </div>
        <iconify-icon icon="ph:buildings-duotone" class="text-2xl text-blue-500"></iconify-icon>
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">scope of visibility</div>
    </div>

  </div>

  <!-- table -->
  <div class="glass rounded-2xl p-5 shadow overflow-hidden">
    <div class="overflow-x-auto fancy-scroll">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead>
          <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            <th class="px-4 py-3">user</th>
            <th class="px-4 py-3">email</th>
            <th class="px-4 py-3">branch</th>
            <th class="px-4 py-3">status</th>
            <th class="px-4 py-3">created</th>
            <th class="px-4 py-3 text-right">actions</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">

          <!-- pending section -->
          <tr class="bg-amber-50/40 dark:bg-amber-500/10">
            <td colspan="6" class="px-4 py-3 text-sm font-semibold text-amber-700 dark:text-amber-300">
              pending accounts
            </td>
          </tr>

          {% for p in pending_profiles %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
              <td class="px-4 py-3 font-medium">{{ p.user.username }}</td>
              <td class="px-4 py-3">{{ p.user.email|default:"—" }}</td>
              <td class="px-4 py-3">{{ p.branch|default:"—" }}</td>
              <td class="px-4 py-3">
                <span class="status-badge status-onleave">pending</span>
              </td>
              <td class="px-4 py-3">
                {% if p.created_at %}{{ p.created_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}
              </td>

              <td class="px-4 py-3 text-right">
                <div class="inline-flex items-center gap-2">

                  <!-- approve -->
                  <form method="post" action="{% url 'approve_user' p.id %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-approve ripple">
                      <iconify-icon icon="ph:check-circle-duotone"></iconify-icon>
                      approve
                    </button>
                  </form>

                  <!-- reject -->
                  <form method="post" action="{% url 'reject_user' p.id %}" class="inline"
                        onsubmit="return confirm('reject this account? this will remove the user from the system.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-reject ripple">
                      <iconify-icon icon="ph:x-circle-duotone"></iconify-icon>
                      reject
                    </button>
                  </form>

                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-6 text-center text-sm text-slate-500">
                no pending accounts
              </td>
            </tr>
          {% endfor %}

          <!-- approved section -->
          <tr class="bg-emerald-50/40 dark:bg-emerald-500/10">
            <td colspan="6" class="px-4 py-3 text-sm font-semibold text-emerald-700 dark:text-emerald-300">
              approved accounts
            </td>
          </tr>

          {% for p in approved_profiles %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
              <td class="px-4 py-3 font-medium">{{ p.user.username }}</td>
              <td class="px-4 py-3">{{ p.user.email|default:"—" }}</td>
              <td class="px-4 py-3">{{ p.branch|default:"—" }}</td>
              <td class="px-4 py-3">
                <span class="status-badge status-active">approved</span>
              </td>
              <td class="px-4 py-3">
                {% if p.created_at %}{{ p.created_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}
              </td>
              <td class="px-4 py-3 text-right">
                <span class="text-xs text-slate-400">—</span>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-6 text-center text-sm text-slate-500">
                no approved accounts yet
              </td>
            </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  // theme handling (kept from your file)
  const themeToggle = document.getElementById('themeToggle');
  function setThemeMode(mode) {
    if (mode === 'dark') document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    localStorage.setItem('ih_theme', mode);
    localStorage.setItem('iht_theme_v1', mode);
  }
  const savedTheme = localStorage.getItem('ih_theme') || localStorage.getItem('iht_theme_v1') || 'light';
  setThemeMode(savedTheme);
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      setThemeMode(document.documentElement.classList.contains('dark') ? 'light' : 'dark');
    });
  }

  // toast system
  const toastHost = document.getElementById('toastHost');
  function showToast(msg, type = 'info', duration = 3200) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <div class="flex items-center gap-2">
        <iconify-icon icon="ph:${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warn' ? 'warning-circle' : 'info'}"></iconify-icon>
        <div>${msg}</div>
      </div>
    `;
    toastHost.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => toast.remove(), 250);
    }, duration);
  }

  // django messages -> toast
  {% if messages %}
    {% for m in messages %}
      showToast("{{ m|escapejs }}", "{{ m.tags|default:'info' }}");
    {% endfor %}
  {% endif %}
</script>
{% endblock %}
